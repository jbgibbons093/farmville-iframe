<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Hughberry Farms HUD</title>
  <link href="fonts.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html {
      margin: 0;
      padding: 0;
      background: transparent !important;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background: transparent !important;
      overflow: visible;
      margin: 0;
      padding: 0;
      pointer-events: none;
      width: 100%;
    }

    .hud-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* ═══ MAIN HUD BAR ═══ */
    .hud-bar {
      display: inline-flex;
      align-items: center;
      gap: 20px;
      padding: 10px 24px;
      background: rgba(0, 0, 0, 0.75);
      border: 4px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      pointer-events: none;
      margin-top: 8px;
      backdrop-filter: blur(4px);
    }

    /* ── Stat Groups ── */
    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-icon {
      font-size: 26px;
      filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.8));
    }

    .xp-sparkle {
      font-size: 22px;
      filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.8));
    }

    .stat-value {
      font-size: 26px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 2px 2px 0 #000;
      line-height: 1;
    }

    .stat-value.level-val {
      color: #89CFF0;
    }

    .xp-label-color {
      color: #E8686A;
    }

    .stat-divider {
      width: 2px;
      height: 28px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 1px;
    }

    /* ── XP Bar ── */
    .xp-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .xp-label {
      font-size: 26px;
      font-weight: 900;
      color: #E8686A;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 0 #000;
      line-height: 1;
    }

    .xp-bar {
      width: 160px;
      height: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
    }

    .xp-bar-fill {
      height: 100%;
      background: #E8686A;
      border-radius: 8px;
      transition: width 0.5s ease;
    }

    .xp-text {
      font-size: 20px;
      font-weight: 900;
      color: #E8686A;
      text-shadow: 2px 2px 0 #000;
      white-space: nowrap;
      line-height: 1;
    }

    /* ═══ BELOW-HUD NOTIFICATIONS ═══ */
    .hud-notif-below {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      padding: 10px 24px;
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid rgba(255, 215, 0, 0.4);
      border-radius: 14px;
      font-size: 17px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 1px 1px 0 #000;
      pointer-events: none;
      animation: notifBounce 2s ease-in-out infinite;
      text-transform: uppercase;
      letter-spacing: 1px;
      backdrop-filter: blur(4px);
    }

    .first-join-notif {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      padding: 10px 24px;
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid rgba(255, 215, 0, 0.4);
      border-radius: 14px;
      font-size: 17px;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 1px 1px 0 #000;
      pointer-events: none;
      animation: notifBounce 1.5s ease-in-out infinite;
      text-transform: uppercase;
      letter-spacing: 1px;
      backdrop-filter: blur(4px);
    }

    .first-join-notif .fj-icon {
      font-size: 22px;
    }

    /* ═══ FLOATING TOAST NOTIFICATIONS (top-right) ═══ */
    .hud-notifications {
      position: fixed;
      top: 70px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
      z-index: 1000;
    }

    .hud-notif {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid rgba(255, 255, 255, 0.15);
      font-size: 17px;
      font-weight: 900;
      color: #fff;
      text-shadow: 1px 1px 0 #000;
      pointer-events: none;
      animation: notifSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 1px;
      backdrop-filter: blur(4px);
    }

    .hud-notif.item-gain { color: #5dff8a; border-color: rgba(93, 255, 138, 0.3); }
    .hud-notif.xp-gain { color: #FFD700; border-color: rgba(255, 215, 0, 0.3); }
    .hud-notif.gold-gain { color: #FFD700; border-color: rgba(255, 215, 0, 0.3); }
    .hud-notif.level-up {
      color: #FFD700;
      border-color: rgba(255, 215, 0, 0.5);
      font-size: 20px;
      animation: notifSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, levelUpFlash 0.6s ease-in-out 3;
    }

    .hud-notif .notif-icon {
      font-size: 22px;
    }

    .hud-notif.fade-out {
      animation: notifFadeOut 0.5s ease forwards;
    }

    /* ═══ ANIMATIONS ═══ */
    @keyframes notifBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    @keyframes notifSlideIn {
      0% { transform: translateX(120px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes notifFadeOut {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(80px); opacity: 0; }
    }

    @keyframes levelUpFlash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.5); }
    }
  </style>
</head>
<body>
  <div class="hud-wrapper">
    <div class="hud-bar">
      <!-- Gold -->
      <div class="stat">
        <span class="stat-icon">&#x1FA99;</span>
        <span class="stat-value" id="gold-value">0</span>
      </div>

      <div class="stat-divider"></div>

      <!-- Level -->
      <div class="stat">
        <span class="stat-icon">&#x2B50;</span>
        <span class="stat-value level-val">Lv.<span id="level-value">0</span></span>
      </div>

      <div class="stat-divider"></div>

      <!-- XP -->
      <div class="xp-group">
        <span class="xp-sparkle">&#x2728;</span>
        <span class="xp-label xp-label-color">XP</span>
        <div class="xp-bar">
          <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
        </div>
        <span class="xp-text" id="xp-text">0 / 100</span>
      </div>
    </div>

    <div id="talent-notif" class="hud-notif-below" style="display:none"></div>
    <div id="rebirth-notif" class="hud-notif-below" style="display:none">&#x1F52E; You've reached Level 50! Press L to Rebirth! &#x1F52E;</div>
    <div id="animal-tutorial-notif" class="hud-notif-below" style="display:none">&#x1F404; Press E and go to the Animals tab to start your cows! &#x1F404;</div>
    <div id="craft-tutorial-notif" class="hud-notif-below" style="display:none">&#x2728; Visit the Crafting Table to craft your first item! &#x2728;</div>
    <div id="first-join-notif" class="first-join-notif" style="display:none">
      <span class="fj-icon">&#x1F381;</span>
      <span>Press E to open Inventory &amp; claim FREE seeds!</span>
      <span class="fj-icon">&#x1F33E;</span>
    </div>
  </div>

  <!-- Floating notifications (top-right) -->
  <div id="hud-notifications" class="hud-notifications"></div>

  <script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js"></script>
  <script>
    // ============================================
    // HUGHBERRY FARMS - GLOBAL HUD
    // ============================================

    // XP gain sound - use fetch + AudioContext to bypass autoplay restrictions
    // (HUD has pointer-events:none so it never gets user gestures)
    var _xpAudioCtx = null;
    var _xpSoundBuffer = null;

    (function() {
      try {
        _xpAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        fetch('xp-gain.mp3')
          .then(function(r) { return r.arrayBuffer(); })
          .then(function(buf) { return _xpAudioCtx.decodeAudioData(buf); })
          .then(function(decoded) { _xpSoundBuffer = decoded; })
          .catch(function() {});
      } catch(e) {}
    })();

    function playXpSound() {
      try {
        if (!_xpAudioCtx || !_xpSoundBuffer) return;
        if (_xpAudioCtx.state === 'suspended') _xpAudioCtx.resume();
        var source = _xpAudioCtx.createBufferSource();
        var gain = _xpAudioCtx.createGain();
        source.buffer = _xpSoundBuffer;
        gain.gain.value = 0.5;
        source.connect(gain);
        gain.connect(_xpAudioCtx.destination);
        source.start(0);
      } catch(e) {}
    }

    // Game state - all values come from Portals via Sync_Inventory
    var _tutorialDismissed = {};
    var gold = 0;
    var xp = 0;
    var level = 0;
    var unspentTalentPoints = 0;
    var hasStarterSeeds = 0;

    // Tutorial tracking
    var hasMilkPail = 0;
    var milkCount = 0;
    var hasRecipeFlour = 0;
    var flourCount = 0;
    var cropWheatCount = 0;

    // Previous values for delta detection
    var prevGold = -1;
    var prevXP = -1;
    var prevLevel = -1;
    var prevInventory = {};
    var firstSync = true; // Skip notifications on initial load

    // Item display names and icons for notifications
    var ITEM_INFO = {
      // Crops
      crop_wheat: { name: 'Wheat', icon: '\u{1F33E}' },
      crop_carrot: { name: 'Carrot', icon: '\u{1F955}' },
      crop_corn: { name: 'Corn', icon: '\u{1F33D}' },
      crop_potato: { name: 'Potato', icon: '\u{1F954}' },
      crop_tomato: { name: 'Tomato', icon: '\u{1F345}' },
      crop_pumpkin: { name: 'Pumpkin', icon: '\u{1F383}' },
      // Seeds
      seeds_wheat: { name: 'Wheat Seeds', icon: '\u{1F331}' },
      seeds_carrot: { name: 'Carrot Seeds', icon: '\u{1F331}' },
      seeds_corn: { name: 'Corn Seeds', icon: '\u{1F331}' },
      seeds_potato: { name: 'Potato Seeds', icon: '\u{1F331}' },
      seeds_tomato: { name: 'Tomato Seeds', icon: '\u{1F331}' },
      seeds_pumpkin: { name: 'Pumpkin Seeds', icon: '\u{1F331}' },
      // Animal products
      milk: { name: 'Milk', icon: '\u{1F95B}' },
      wool: { name: 'Wool', icon: '\u{1F411}' },
      goat_meat: { name: 'Goat Meat', icon: '\u{1F356}' },
      truffle: { name: 'Truffle', icon: '\u{1F344}' },
      egg: { name: 'Egg', icon: '\u{1F95A}' },
      honey: { name: 'Honey', icon: '\u{1F36F}' },
      // Crafted items
      flour: { name: 'Flour', icon: '\u{1F4E6}' },
      bread: { name: 'Bread', icon: '\u{1F35E}' },
      cheese: { name: 'Cheese', icon: '\u{1F9C0}' },
      stew: { name: 'Stew', icon: '\u{1F372}' },
      ragout: { name: 'Ragout', icon: '\u{1F35B}' },
      pie: { name: 'Pie', icon: '\u{1F967}' },
      meat_pie: { name: 'Meat Pie', icon: '\u{1F967}' },
      blanket: { name: 'Blanket', icon: '\u{1F9F6}' },
      butter: { name: 'Butter', icon: '\u{1F9C8}' },
      cake: { name: 'Cake', icon: '\u{1F370}' },
      mead: { name: 'Mead', icon: '\u{1F37A}' }
    };

    // Keys to track for delta notifications (subset of SYNC_MAP that are inventory items)
    var TRACKED_KEYS = [
      'crop_wheat', 'crop_carrot', 'crop_corn', 'crop_potato', 'crop_tomato', 'crop_pumpkin',
      'seeds_wheat', 'seeds_carrot', 'seeds_corn', 'seeds_potato', 'seeds_tomato', 'seeds_pumpkin',
      'milk', 'wool', 'goat_meat', 'truffle', 'egg', 'honey',
      'flour', 'bread', 'cheese', 'stew', 'ragout', 'pie', 'meat_pie', 'blanket', 'butter', 'cake', 'mead'
    ];

    // XP required at each level to advance (XP resets to 0 on level-up)
    var levelThresholds = [
      50, 75, 100, 125, 150, 200, 250, 300, 375, 450,
      525, 600, 700, 800, 900, 1000, 1100, 1250, 1400, 1600,
      1800, 2000, 2200, 2500, 2800, 3000, 3300, 3600, 4000, 4500,
      5000, 5500, 6000, 6500, 7000, 7500, 8000, 8500, 9000, 9500,
      10000, 10500, 11000, 11500, 12000, 12500, 13000, 13500, 14000, 15000
    ];

    // ============================================
    // NOTIFICATION SYSTEM
    // ============================================

    function showHudNotification(html, type, duration) {
      var container = document.getElementById('hud-notifications');
      // Cap at 6 notifications
      while (container.children.length >= 6) {
        container.removeChild(container.firstChild);
      }
      var notif = document.createElement('div');
      notif.className = 'hud-notif ' + type;
      notif.innerHTML = html;
      container.appendChild(notif);
      var dur = duration || 4000;
      setTimeout(function() {
        notif.classList.add('fade-out');
        setTimeout(function() { if (notif.parentNode) notif.remove(); }, 500);
      }, dur);
    }

    function checkDeltas(data) {
      if (firstSync) {
        // Store initial values, don't show notifications
        firstSync = false;
        if (data.gold !== undefined) prevGold = data.gold;
        if (data.xp !== undefined) prevXP = data.xp;
        if (data.level !== undefined) prevLevel = data.level;
        TRACKED_KEYS.forEach(function(key) {
          if (data[key] !== undefined) prevInventory[key] = data[key];
        });
        return;
      }

      // Check level up first (most exciting)
      if (data.level !== undefined && prevLevel >= 0 && data.level > prevLevel) {
        showHudNotification(
          '<span class="notif-icon">\u{2B50}</span> LEVEL UP! Now Lv.' + data.level + '!',
          'level-up', 5000
        );
      }

      // Check gold gain
      if (data.gold !== undefined && prevGold >= 0 && data.gold > prevGold) {
        var goldDelta = data.gold - prevGold;
        showHudNotification(
          '<span class="notif-icon">\u{1FA99}</span> +' + goldDelta.toLocaleString() + ' Gold',
          'gold-gain', 3500
        );
      }

      // Check item gains - group all item changes into one notification
      var itemGains = [];
      TRACKED_KEYS.forEach(function(key) {
        if (data[key] !== undefined) {
          var prev = prevInventory[key] !== undefined ? prevInventory[key] : 0;
          if (data[key] > prev) {
            var delta = data[key] - prev;
            var info = ITEM_INFO[key];
            if (info) {
              itemGains.push({ icon: info.icon, name: info.name, delta: delta });
            }
          }
        }
      });

      if (itemGains.length > 0) {
        // Build notification: show up to 3 items
        var parts = [];
        for (var g = 0; g < Math.min(itemGains.length, 3); g++) {
          parts.push(itemGains[g].icon + ' +' + itemGains[g].delta + ' ' + itemGains[g].name);
        }
        if (itemGains.length > 3) parts.push('...');
        showHudNotification(
          parts.join('  '),
          'item-gain', 4000
        );
      }

      // Check XP gain (show after items so it appears below)
      if (data.xp !== undefined && prevXP >= 0) {
        // XP can reset on level up, so only show gain if level didn't change
        var levelChanged = data.level !== undefined && prevLevel >= 0 && data.level !== prevLevel;
        if (!levelChanged && data.xp > prevXP) {
          var xpDelta = data.xp - prevXP;
          showHudNotification(
            '<span class="notif-icon">\u{2728}</span> +' + xpDelta + ' XP',
            'xp-gain', 3000
          );
          playXpSound();
        }
      }

      // Update previous values
      if (data.gold !== undefined) prevGold = data.gold;
      if (data.xp !== undefined) prevXP = data.xp;
      if (data.level !== undefined) prevLevel = data.level;
      TRACKED_KEYS.forEach(function(key) {
        if (data[key] !== undefined) prevInventory[key] = data[key];
      });
    }

    function checkFirstJoinNotif(data) {
      var fjNotif = document.getElementById('first-join-notif');
      if (data.has_starter_seeds !== undefined) hasStarterSeeds = data.has_starter_seeds;
      if (data.level !== undefined) level = data.level;
      // Show if player hasn't claimed starter seeds and is level 0
      if (hasStarterSeeds === 0 && level === 0) {
        fjNotif.style.display = 'flex';
      } else {
        fjNotif.style.display = 'none';
      }
    }

    // ============================================
    // UI UPDATE FUNCTIONS
    // ============================================

    function updateHUD() {
      // Update gold
      document.getElementById('gold-value').textContent = gold.toLocaleString();

      // Update level
      document.getElementById('level-value').textContent = level;

      // XP resets each level - progress is current XP / threshold for current level
      var isMaxLevel = level >= levelThresholds.length;
      var xpNeeded = isMaxLevel ? 0 : levelThresholds[level];
      var xpPercent = isMaxLevel ? 100 : Math.min(100, Math.max(0, (xp / xpNeeded) * 100));

      // Update XP bar - show "current / needed"
      var xpText = isMaxLevel ? xp.toLocaleString() + ' (MAX)' : xp.toLocaleString() + ' / ' + xpNeeded.toLocaleString();
      document.getElementById('xp-text').textContent = xpText;
      document.getElementById('xp-bar-fill').style.width = xpPercent + '%';

      // Talent point notification
      var talentNotif = document.getElementById('talent-notif');
      if (unspentTalentPoints > 0) {
        talentNotif.innerHTML = '\u{2728} ' + unspentTalentPoints + ' Talent Point' + (unspentTalentPoints > 1 ? 's' : '') + ' available! Press Y \u{2728}';
        talentNotif.style.display = 'flex';
      } else {
        talentNotif.style.display = 'none';
      }

      // Rebirth ready notification
      var rebirthNotif = document.getElementById('rebirth-notif');
      if (level >= 50) {
        rebirthNotif.style.display = 'flex';
      } else {
        rebirthNotif.style.display = 'none';
      }

      // Tutorial: Visit barn — only for true beginners (level 2-3, has pail, never collected milk)
      var animalTutorial = document.getElementById('animal-tutorial-notif');
      if (!_tutorialDismissed.animal && hasMilkPail >= 1 && milkCount === 0 && level >= 2 && level <= 3) {
        animalTutorial.style.display = 'flex';
        _tutorialDismissed.animal = true;
        setTimeout(function() { animalTutorial.style.display = 'none'; }, 8000);
      }

      // Tutorial: Visit crafting table — only for beginners (level 4-6, has flour recipe, enough wheat, no flour yet)
      var craftTutorial = document.getElementById('craft-tutorial-notif');
      if (!_tutorialDismissed.craft && hasRecipeFlour >= 1 && flourCount === 0 && cropWheatCount >= 3 && level <= 6) {
        craftTutorial.style.display = 'flex';
        _tutorialDismissed.craft = true;
        setTimeout(function() { craftTutorial.style.display = 'none'; }, 8000);
      }
    }

    // ============================================
    // PORTALS SDK INTEGRATION
    // ============================================

    var sdkReady = false;

    function triggerTask(taskName) {
      if (!sdkReady) {
        console.log('[HUD] SDK not ready, skipping task:', taskName);
        return;
      }
      try {
        if (typeof PortalsSdk !== 'undefined' && PortalsSdk.sendMessageToUnity) {
          PortalsSdk.sendMessageToUnity(JSON.stringify({
            TaskName: taskName,
            TaskTargetState: 'SetNotActiveToActive'
          }));
          console.log('[HUD] Task triggered:', taskName);
        }
      } catch (e) {
        console.log('[HUD] Error triggering task:', e);
      }
    }

    // Message deduplication
    var lastMessageId = '';
    var lastMessageTime = 0;

    function processMessage(msg, source) {
      var now = Date.now();
      var msgId = msg + '_' + Math.floor(now / 100);
      if (msgId === lastMessageId && now - lastMessageTime < 200) {
        console.log('[HUD] Duplicate message ignored:', source);
        return;
      }
      lastMessageId = msgId;
      lastMessageTime = now;
      handlePortalsMessage(msg);
    }

    // === Standard Sync_Inventory Parser (same in all iframes) ===
    var SYNC_MAP = {
      'Has_Milk_Pail': 'has_milk_pail', 'Has_Shearing_Kit': 'has_shearing_kit',
      'Has_Butcher_Knife': 'has_butcher_knife', 'Has_Truffle_Spade': 'has_truffle_spade',
      'Has_Starter_Seeds': 'has_starter_seeds',
      'Seeds_Wheat': 'seeds_wheat', 'Seeds_Carrot': 'seeds_carrot', 'Seeds_Corn': 'seeds_corn',
      'Seeds_Potato': 'seeds_potato', 'Seeds_Tomato': 'seeds_tomato', 'Seeds_Pumpkin': 'seeds_pumpkin',
      'Crop_Wheat': 'crop_wheat', 'Crop_Carrot': 'crop_carrot', 'Crop_Corn': 'crop_corn',
      'Crop_Potato': 'crop_potato', 'Crop_Tomato': 'crop_tomato', 'Crop_Pumpkin': 'crop_pumpkin',
      'Goat_Meat': 'goat_meat', 'Meat_Pie': 'meat_pie',
      'Has_Basket': 'has_basket', 'Has_Beesuit': 'has_beesuit',
      'Milk_Uncollected': 'milk_uncollected', 'Eggs_Uncollected': 'eggs_uncollected',
      'Wool_Uncollected': 'wool_uncollected', 'Meat_Uncollected': 'meat_uncollected',
      'Truffle_Uncollected': 'truffle_uncollected', 'Honey_Uncollected': 'honey_uncollected',
      'Gold': 'gold', 'XP': 'xp', 'Level': 'level',
      'Milk': 'milk', 'Wool': 'wool', 'Truffle': 'truffle', 'Egg': 'egg', 'Honey': 'honey',
      'Flour': 'flour', 'Bread': 'bread', 'Cheese': 'cheese', 'Stew': 'stew',
      'Ragout': 'ragout', 'Pie': 'pie', 'Blanket': 'blanket', 'Butter': 'butter',
      'Cake': 'cake', 'Mead': 'mead',
      'Has_Recipe_Flour': 'has_recipe_flour', 'Has_Recipe_Bread': 'has_recipe_bread',
      'Has_Recipe_Cheese': 'has_recipe_cheese', 'Has_Recipe_Stew': 'has_recipe_stew',
      'Has_Recipe_Ragout': 'has_recipe_ragout', 'Has_Recipe_Pie': 'has_recipe_pie',
      'Has_Recipe_Meat_Pie': 'has_recipe_meat_pie', 'Has_Recipe_Blanket': 'has_recipe_blanket',
      'Has_Recipe_Butter': 'has_recipe_butter', 'Has_Recipe_Cake': 'has_recipe_cake',
      'Has_Recipe_Mead': 'has_recipe_mead',
      'Unspent_Talent_Points': 'unspent_talent_points',
      'T_PlotRow2': 't_plotrow2', 'T_GreenThumb': 't_greenthumb',
      'T_EagerPlanter': 't_eagerplanter', 'T_PlotRow3': 't_plotrow3',
      'T_BountifulHarvest': 't_bountifulharvest', 'T_RapidGrowth': 't_rapidgrowth',
      'T_PlotRow4': 't_plotrow4', 'T_CropMastery': 't_cropmastery',
      'T_CowHerd': 't_cowherd', 'T_ChickenFlock': 't_chickenflock',
      'T_QuickHands': 't_quickhands', 'T_SheepPen': 't_sheepppen',
      'T_GoatYard': 't_goatyard', 'T_ApiaryExpansion': 't_apiaryexpansion',
      'T_HusbandryKnowledge': 't_husbandryknowledge', 'T_PigSty': 't_pigsty',
      'T_AnimalMastery': 't_animalmastery', 'T_KeenLearner': 't_keenlearner',
      'T_FarmHand': 't_farmhand', 'T_Stockman': 't_stockman',
      'T_Artisan': 't_artisan', 'T_SeasonedWorker': 't_seasonedworker',
      'T_BonusPoint1': 't_bonuspoint1', 'T_Prodigy': 't_prodigy',
      'T_BonusPoint2': 't_bonuspoint2',
      'T_Contractor1': '_skip', 'T_Contractor2': '_skip', 'T_Contractor3': '_skip',
      'Rebirth_Shards': '_skip', 'Mystic_Essence': '_skip',
      'RT_FleetHarvest': '_skip', 'RT_SwiftHusbandry': '_skip',
      'RT_QuickContracts': '_skip', 'RT_RushingWinds': '_skip',
      'RT_NimbleHands': '_skip', 'RT_TimeWarp': '_skip',
      'RT_Windfall': '_skip', 'RT_GreenFingers': '_skip',
      'RT_Stockpiler': '_skip', 'RT_ArtisanTouch': '_skip',
      'RT_Fortune': '_skip', 'RT_Cornucopia': '_skip',
      'RT_NestEgg': '_skip', 'RT_SeedVault': '_skip',
      'RT_Seasoned': '_skip', 'RT_ToolShed': '_skip',
      'RT_RecipeTome': '_skip', 'RT_QuickStart': '_skip',
      'Rebirth_Count': 'rebirth_count',
      'Contract_1_Done': '_skip', 'Contract_2_Done': '_skip', 'Contract_3_Done': '_skip',
      'Contract_4_Done': '_skip', 'Contract_5_Done': '_skip', 'Contract_6_Done': '_skip',
      'Contract_7_Done': '_skip', 'Contract_8_Done': '_skip', 'Contract_9_Done': '_skip',
      'Contract_10_Done': '_skip',
      'playerName': '_skip'
    };

    function parseSyncMessage(msg) {
      var parts = msg.replace('Sync_Inventory_', '').split('_');
      var data = {};
      var i = 0;
      while (i < parts.length) {
        var matched = false;
        // 4-word keys (e.g., Has_Recipe_Meat_Pie)
        if (!matched && i + 4 < parts.length) {
          var k4 = parts[i] + '_' + parts[i+1] + '_' + parts[i+2] + '_' + parts[i+3];
          if (SYNC_MAP[k4] !== undefined) {
            var v4 = parseInt(parts[i+4]); data[SYNC_MAP[k4]] = isNaN(v4) ? 0 : v4;
            i += 5; matched = true;
          }
        }
        // 3-word keys
        if (!matched && i + 3 < parts.length) {
          var k3 = parts[i] + '_' + parts[i+1] + '_' + parts[i+2];
          if (SYNC_MAP[k3] !== undefined) {
            var v3 = parseInt(parts[i+3]); data[SYNC_MAP[k3]] = isNaN(v3) ? 0 : v3;
            i += 4; matched = true;
          }
        }
        // 2-word keys
        if (!matched && i + 2 < parts.length) {
          var k2 = parts[i] + '_' + parts[i+1];
          if (SYNC_MAP[k2] !== undefined) {
            var v2 = parseInt(parts[i+2]); data[SYNC_MAP[k2]] = isNaN(v2) ? 0 : v2;
            i += 3; matched = true;
          }
        }
        // 1-word keys
        if (!matched && i + 1 < parts.length && SYNC_MAP[parts[i]] !== undefined) {
          var v1 = parseInt(parts[i+1]); data[SYNC_MAP[parts[i]]] = isNaN(v1) ? 0 : v1;
          i += 2; matched = true;
        }
        if (!matched) i++;
      }
      return data;
    }
    // === End Standard Parser ===

    function handlePortalsMessage(msg) {
      console.log('[HUD] Received message:', msg.substring(0, 100) + '...');

      if (msg.indexOf('Sync_Inventory_') === 0 || (msg.indexOf('_Gold_') !== -1 && msg.indexOf('_XP_') !== -1 && msg.indexOf('_Level_') !== -1)) {
        var data = parseSyncMessage(msg);
        // Check deltas BEFORE updating state (so we compare new vs old)
        checkDeltas(data);
        checkFirstJoinNotif(data);
        if (data.gold !== undefined) gold = data.gold;
        if (data.xp !== undefined) xp = data.xp;
        if (data.level !== undefined) level = data.level;
        if (data.unspent_talent_points !== undefined) unspentTalentPoints = data.unspent_talent_points;
        // Tutorial tracking
        if (data.has_milk_pail !== undefined) hasMilkPail = data.has_milk_pail;
        if (data.milk !== undefined) milkCount = data.milk;
        if (data.has_recipe_flour !== undefined) hasRecipeFlour = data.has_recipe_flour;
        if (data.flour !== undefined) flourCount = data.flour;
        if (data.crop_wheat !== undefined) cropWheatCount = data.crop_wheat;
        updateHUD();
        console.log('[HUD] Updated - Gold:', gold, 'XP:', xp, 'Level:', level);
      }
      else if (msg.indexOf('init_') === 0 || msg.indexOf('hud_') === 0) {
        var parts = msg.split('_');
        if (parts.length >= 4) {
          gold = parseInt(parts[1]) || 0;
          level = parseInt(parts[2]) || 0;
          xp = parseInt(parts[3]) || 0;
          updateHUD();
        }
      }
    }

    // Setup message listener with retry for SDK initialization
    function setupMessageListener() {
      if (typeof PortalsSdk !== 'undefined' && PortalsSdk.setMessageListener) {
        PortalsSdk.setMessageListener(function(msg) {
          processMessage(msg, 'SDK');
        });
        console.log('[HUD] SDK listener registered');
        sdkReady = true;
        // Request initial sync now that SDK is ready
        setTimeout(function() {
          triggerTask('Sync_Inventory');
        }, 300);
      } else {
        console.log('[HUD] Waiting for SDK...');
        setTimeout(setupMessageListener, 100);
      }
    }

    // Also listen via window.postMessage as fallback
    window.addEventListener('message', function(event) {
      if (event.data && typeof event.data === 'string') {
        processMessage(event.data, 'postMessage-string');
      }
      else if (event.data && event.data.portalsMessage) {
        processMessage(event.data.portalsMessage, 'postMessage-portals');
      }
      else if (event.data && event.data.message && typeof event.data.message === 'string') {
        processMessage(event.data.message, 'postMessage-message');
      }
    });

    // Re-request Sync_Inventory when iframe regains visibility or focus
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) { triggerTask('Sync_Inventory'); }
    });
    window.addEventListener('focus', function() {
      triggerTask('Sync_Inventory');
    });

    // ============================================
    // INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log('[HUD] Hughberry Farms HUD loaded');
      setupMessageListener();
      updateHUD();
    });
  </script>
</body>
</html>
