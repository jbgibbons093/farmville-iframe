<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Hughberry Farms - Rebirth Blessings</title>
<link href="fonts.css" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: transparent;
  min-height: 100vh;
  color: #fff;
  overflow: hidden;
}

.overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
}

.blessing-container {
  width: 95vw;
  max-width: 1100px;
  max-height: 96vh;
  background: #0d0518;
  border: 6px solid #000;
  border-radius: 28px;
  box-shadow: 8px 8px 0 #000, 0 0 60px rgba(142,68,173,0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  color: #fff;
}

/* ── Header ── */
.blessing-header {
  background: #8e44ad;
  padding: 18px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 5px solid #000;
  flex-shrink: 0;
  gap: 10px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-icon { font-size: 32px; filter: drop-shadow(2px 2px 0 #000); }

.header-title {
  font-family: 'Luckiest Guy', cursive;
  font-size: 34px;
  color: #fff;
  text-shadow: 3px 3px 0 #000, -1px -1px 0 #000;
  letter-spacing: 3px;
  text-transform: uppercase;
}

.shards-badge {
  background: #0d0518;
  border: 4px solid #cc88ff;
  border-radius: 14px;
  padding: 10px 18px;
  font-weight: 900;
  font-size: 18px;
  color: #cc88ff;
  text-shadow: 2px 2px 0 #000;
  white-space: nowrap;
}

.essence-badge {
  background: #0d0518;
  border: 4px solid #FFD700;
  border-radius: 14px;
  padding: 10px 16px;
  font-weight: 900;
  font-size: 20px;
  color: #FFD700;
  text-shadow: 2px 2px 0 #000;
  white-space: nowrap;
}

.respec-btn {
  padding: 12px 24px;
  border-radius: 14px;
  border: 4px solid #000;
  background: #e74c3c;
  color: #fff;
  font-family: 'Nunito', sans-serif;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 4px 4px 0 #000;
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.respec-btn:hover {
  transform: scale(1.1) translateY(-3px) rotate(-1deg);
  box-shadow: 6px 8px 0 #000;
  background: #ff5555;
}
.respec-btn:active {
  transform: scale(0.93) translateY(3px);
  box-shadow: 2px 2px 0 #000;
}
.respec-btn:disabled {
  background: #333;
  border-color: #222;
  color: #555;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
  pointer-events: none;
}

.close-btn {
  background: #ff4444;
  border: 4px solid #000;
  color: #fff;
  width: 48px;
  height: 48px;
  border-radius: 14px;
  cursor: pointer;
  font-size: 24px;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  flex-shrink: 0;
  box-shadow: 3px 3px 0 #000;
}
.close-btn:hover {
  transform: scale(1.15) rotate(-5deg);
  box-shadow: 5px 5px 0 #000;
  background: #ff6666;
}

/* ── Tree Tabs ── */
.tree-tabs {
  display: flex;
  background: #080412;
  border-bottom: 5px solid #000;
  flex-shrink: 0;
}

.tree-tab {
  flex: 1;
  padding: 14px 8px;
  text-align: center;
  cursor: pointer;
  font-weight: 900;
  font-size: 16px;
  color: #7a5a9a;
  border-bottom: 4px solid transparent;
  transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
  font-family: 'Nunito', sans-serif;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.tree-tab:hover { color: #cc88ff; background: rgba(142, 68, 173, 0.15); transform: scale(1.04); }
.tree-tab.active {
  color: #cc88ff;
  border-bottom-color: #8e44ad;
  background: #0e0620;
}

.tree-tab .tab-icon { font-size: 18px; display: block; margin-bottom: 2px; }
.tree-tab .tab-label { display: block; }
.tree-tab .tab-points {
  display: block;
  font-size: 12px;
  color: #888;
  margin-top: 1px;
}
.tree-tab.active .tab-points { color: #aa88cc; }

/* ── Tree Canvas Container ── */
.tree-canvas-container {
  flex: 1;
  overflow: auto;
  position: relative;
  padding: 16px;
}

.tree-canvas-container::-webkit-scrollbar { width: 14px; height: 14px; }
.tree-canvas-container::-webkit-scrollbar-track { background: #080412; }
.tree-canvas-container::-webkit-scrollbar-thumb { background: #8e44ad; border-radius: 10px; border: 3px solid #000; }

.tree-canvas {
  position: relative;
  width: 100%;
  min-height: 500px;
}

/* ── SVG Lines ── */
.tree-lines {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}

.tree-line {
  stroke: #444;
  stroke-width: 3;
  fill: none;
}
.tree-line.unlocked {
  stroke: #bb77ee;
  filter: drop-shadow(0 0 3px rgba(187, 119, 238, 0.5));
}
.tree-line.maxed {
  stroke: #ddaaff;
  filter: drop-shadow(0 0 4px rgba(221, 170, 255, 0.6));
}

/* ── Blessing Nodes ── */
.talent-node {
  position: absolute;
  width: 84px;
  height: 84px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 2;
  transform: translate(-50%, -50%);
}

.talent-node:hover {
  transform: translate(-50%, -50%) scale(1.08);
}

.node-circle {
  width: 68px;
  height: 68px;
  border-radius: 50%;
  background: #1a0e30;
  border: 3px solid #6a3a8a;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  transition: all 0.2s;
  position: relative;
  box-shadow: 4px 4px 0 #000;
}

.talent-node.locked .node-circle {
  opacity: 0.4;
  filter: grayscale(0.7);
  border-color: #333;
}

.talent-node.available .node-circle {
  border-color: #bb77ee;
  box-shadow: 4px 4px 0 #000, 0 0 12px rgba(187, 119, 238, 0.4);
  animation: pulse-celestial 2s infinite;
}

.talent-node.invested .node-circle {
  border-color: #8e44ad;
  background: #2a1a40;
}

.talent-node.maxed .node-circle {
  border-color: #FFD700;
  background: #2a1a40;
  box-shadow: 4px 4px 0 #000, 0 0 16px rgba(255, 215, 0, 0.4);
}

@keyframes pulse-celestial {
  0%, 100% { box-shadow: 4px 4px 0 #000, 0 0 12px rgba(187, 119, 238, 0.4); }
  50% { box-shadow: 4px 4px 0 #000, 0 0 22px rgba(187, 119, 238, 0.7); }
}

.node-rank {
  position: absolute;
  bottom: -4px;
  right: -4px;
  background: #0d0518;
  border: 2px solid #6a3a8a;
  border-radius: 8px;
  padding: 2px 6px;
  font-size: 12px;
  font-weight: 800;
  color: #aaa;
}

.talent-node.invested .node-rank,
.talent-node.available .node-rank {
  color: #bb77ee;
  border-color: #8e44ad;
}

.talent-node.maxed .node-rank {
  color: #FFD700;
  border-color: #FFD700;
  background: #2a1a40;
}

.node-name {
  font-size: 11px;
  font-weight: 700;
  color: #aaa;
  text-align: center;
  margin-top: 4px;
  max-width: 90px;
  line-height: 1.1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}

.talent-node.available .node-name,
.talent-node.invested .node-name {
  color: #ccc;
}

.talent-node.maxed .node-name {
  color: #FFD700;
}

/* ── Tooltip ── */
.tooltip {
  position: fixed;
  background: #0d0518;
  border: 5px solid #8e44ad;
  border-radius: 18px;
  padding: 16px 18px;
  max-width: 290px;
  z-index: 100;
  pointer-events: none;
  box-shadow: 6px 6px 0 #000;
  opacity: 0;
  transition: opacity 0.15s;
}

.tooltip.visible {
  opacity: 1;
}

.tooltip-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.tooltip-icon {
  font-size: 28px;
}

.tooltip-title {
  font-weight: 800;
  font-size: 20px;
  color: #cc88ff;
}

.tooltip-rank {
  font-size: 13px;
  color: #888;
  margin-bottom: 6px;
}

.tooltip-desc {
  font-size: 14px;
  color: #ccc;
  line-height: 1.4;
  margin-bottom: 8px;
}

.tooltip-prereq {
  font-size: 13px;
  font-weight: 700;
  color: #e74c3c;
  padding: 8px 12px;
  background: #000;
  border: 3px solid #e74c3c;
  border-radius: 10px;
  margin-bottom: 6px;
}

.tooltip-prereq.met {
  color: #cc88ff;
  background: #0d0518;
  border-color: #8e44ad;
}

.tooltip-tier {
  font-size: 12px;
  color: #888;
}

/* ── Tier Labels ── */
.tier-label {
  position: absolute;
  left: 10px;
  font-size: 13px;
  font-weight: 800;
  color: #5a3a6a;
  text-transform: uppercase;
  letter-spacing: 1px;
  transform: translateY(-50%);
}

.tier-label.unlocked {
  color: #8a6a9a;
}

/* ── Respec Modal ── */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.modal-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.modal {
  background: #0d0518;
  border: 6px solid #000;
  border-radius: 22px;
  padding: 28px;
  max-width: 400px;
  text-align: center;
  box-shadow: 8px 8px 0 #000;
}

.modal-icon {
  font-size: 56px;
  margin-bottom: 12px;
}

.modal-title {
  font-family: 'Luckiest Guy', cursive;
  font-size: 32px;
  color: #cc88ff;
  margin-bottom: 12px;
  text-shadow: 3px 3px 0 #000;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.modal-text {
  font-size: 15px;
  color: #ccc;
  line-height: 1.5;
  margin-bottom: 16px;
}

.modal-cost {
  font-size: 20px;
  font-weight: 800;
  color: #cc88ff;
  margin-bottom: 20px;
}

.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.modal-btn {
  padding: 10px 24px;
  border-radius: 10px;
  font-family: 'Nunito', sans-serif;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.modal-btn.confirm {
  background: #8e44ad;
  border: 4px solid #000;
  color: #fff;
  box-shadow: 4px 4px 0 #000;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.modal-btn.confirm:hover {
  background: #a855c8;
  transform: scale(1.1) translateY(-3px) rotate(-1deg);
  box-shadow: 6px 8px 0 #000;
}
.modal-btn.confirm:active {
  transform: scale(0.93) translateY(3px);
  box-shadow: 2px 2px 0 #000;
}

.modal-btn.cancel {
  background: #333;
  border: 4px solid #000;
  color: #aaa;
  box-shadow: 4px 4px 0 #000;
  font-weight: 900;
  text-transform: uppercase;
}
.modal-btn.cancel:hover {
  background: #444;
  color: #fff;
  transform: scale(1.08) translateY(-2px);
  box-shadow: 6px 6px 0 #000;
}
.modal-btn.cancel:active {
  transform: scale(0.93) translateY(3px);
  box-shadow: 2px 2px 0 #000;
}

/* ── Notifications ── */
#notifications {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 6px;
  pointer-events: none;
}

.notification {
  padding: 16px 28px;
  border-radius: 14px;
  font-weight: 900;
  font-size: 16px;
  animation: notifIn 0.3s ease, notifOut 0.3s ease 2.7s forwards;
  text-align: center;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.notification.success {
  background: #0d0518;
  border: 4px solid #8e44ad;
  color: #cc88ff;
  box-shadow: 4px 4px 0 rgba(142, 68, 173, 0.3);
}
.notification.error {
  background: #1a0a0a;
  border: 4px solid #e74c3c;
  color: #e74c3c;
  box-shadow: 4px 4px 0 rgba(231, 76, 60, 0.3);
}

@keyframes notifIn {
  from { opacity: 0; transform: translateY(-10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes notifOut {
  from { opacity: 1; }
  to   { opacity: 0; }
}

/* ── Responsive ── */
@media (max-width: 550px) {
  .blessing-container { max-height: 96vh; border-radius: 16px; }
  .blessing-header { padding: 12px 14px; }
  .header-title { font-size: 20px; }
  .node-circle { width: 56px; height: 56px; font-size: 26px; }
  .talent-node { width: 72px; height: 72px; }
  .node-name { font-size: 10px; max-width: 80px; }
}
</style>
</head>
<body>
<script>var _uiPopCtx=null;var _uiPopBuf=null;var _uiPopPlayed=false;try{_uiPopCtx=new(window.AudioContext||window.webkitAudioContext)();fetch('ui-pop.mp3').then(function(r){return r.arrayBuffer()}).then(function(b){return _uiPopCtx.decodeAudioData(b)}).then(function(d){_uiPopBuf=d}).catch(function(){})}catch(e){}</script>

<div class="overlay">
<div class="blessing-container">
  <div class="blessing-header">
    <div class="header-left">
      <span class="header-icon">&#10024;</span>
      <span class="header-title">Rebirth Blessings</span>
    </div>
    <div class="shards-badge" id="shardsBadge">0 Shards</div>
    <div class="essence-badge" id="essenceBadge">&#10024; 0</div>
    <button class="respec-btn" id="respecBtn" onclick="showRespecModal()" disabled>
      <span>&#128260;</span> Respec
    </button>
    <button class="close-btn" onclick="closeIframe()" title="Close">&#10005;</button>
  </div>

  <div class="tree-tabs">
    <button class="tree-tab active" data-tree="haste" onclick="switchTree('haste')">
      <span class="tab-icon">&#9889;</span>
      <span class="tab-label">Haste</span>
      <span class="tab-points" id="tabPointsHaste">0 / 15</span>
    </button>
    <button class="tree-tab" data-tree="abundance" onclick="switchTree('abundance')">
      <span class="tab-icon">&#127808;</span>
      <span class="tab-label">Abundance</span>
      <span class="tab-points" id="tabPointsAbundance">0 / 15</span>
    </button>
    <button class="tree-tab" data-tree="legacy" onclick="switchTree('legacy')">
      <span class="tab-icon">&#127942;</span>
      <span class="tab-label">Legacy</span>
      <span class="tab-points" id="tabPointsLegacy">0 / 15</span>
    </button>
  </div>

  <div class="tree-canvas-container">
    <div class="tree-canvas" id="treeCanvas"></div>
  </div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>

<div class="modal-overlay" id="respecModal">
  <div class="modal">
    <div class="modal-icon">&#128260;</div>
    <div class="modal-title">Respec Blessings?</div>
    <div class="modal-text">This will reset ALL rebirth blessings.<br>You will receive <span id="respecRefund">0</span> shards back.</div>
    <div class="modal-cost">Cost: Free</div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="hideRespecModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmRespec()">Respec</button>
    </div>
  </div>
</div>

<div id="notifications"></div>

<script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js"></script>
<script>
// ── Blessing Tree Definitions ──
var BLESSING_TREES = {
  haste: {
    name: 'Haste',
    maxPoints: 15,
    tiers: [
      { tier: 1, gate: 0, y: 60 },
      { tier: 2, gate: 3, y: 200 },
      { tier: 3, gate: 8, y: 340 }
    ],
    talents: [
      // Tier 1
      { key: 'FleetHarvest', name: 'Fleet Harvest', icon: '\u{1F33E}', maxRank: 3,
        desc: '-3% crop grow time per rank', tier: 1, pos: { x: 25, y: 60 } },
      { key: 'SwiftHusbandry', name: 'Swift Husbandry', icon: '\u{1F404}', maxRank: 3,
        desc: '-3% animal cooldown per rank', tier: 1, pos: { x: 50, y: 60 } },
      { key: 'QuickContracts', name: 'Quick Contracts', icon: '\u{1F4CB}', maxRank: 3,
        desc: '-30% contract refresh time & +0.5x reward multiplier per rank', tier: 1, pos: { x: 75, y: 60 } },
      // Tier 2
      { key: 'RushingWinds', name: 'Rushing Winds', icon: '\u{1F4A8}', maxRank: 2,
        desc: '-4% crop & animal time per rank', tier: 2, pos: { x: 30, y: 200 },
        requires: { key: 'FleetHarvest', rank: 2 } },
      { key: 'NimbleHands', name: 'Nimble Hands', icon: '\u{1F590}', maxRank: 2,
        desc: '-4% crop & animal time per rank', tier: 2, pos: { x: 70, y: 200 },
        requires: { key: 'SwiftHusbandry', rank: 2 } },
      // Tier 3
      { key: 'TimeWarp', name: 'Time Warp', icon: '\u231B', maxRank: 2,
        desc: '-5% ALL timers per rank (crops, animals, contracts)', tier: 3, pos: { x: 50, y: 340 },
        requiresAll: [{ key: 'RushingWinds', rank: 2 }, { key: 'NimbleHands', rank: 2 }] }
    ]
  },
  abundance: {
    name: 'Abundance',
    maxPoints: 15,
    tiers: [
      { tier: 1, gate: 0, y: 60 },
      { tier: 2, gate: 3, y: 200 },
      { tier: 3, gate: 8, y: 340 }
    ],
    talents: [
      // Tier 1
      { key: 'Windfall', name: 'Windfall', icon: '\u{1FA99}', maxRank: 3,
        desc: '+25 gold per level-up per rank', tier: 1, pos: { x: 25, y: 60 } },
      { key: 'GreenFingers', name: 'Green Fingers', icon: '\u{1F33F}', maxRank: 3,
        desc: '+2 planting & harvest XP per rank', tier: 1, pos: { x: 50, y: 60 } },
      { key: 'Stockpiler', name: 'Stockpiler', icon: '\u{1F4E6}', maxRank: 3,
        desc: '+2 animal start & collect XP per rank', tier: 1, pos: { x: 75, y: 60 } },
      // Tier 2
      { key: 'ArtisanTouch', name: 'Artisan Touch', icon: '\u{1F528}', maxRank: 3,
        desc: '+3 crafting XP per rank', tier: 2, pos: { x: 30, y: 200 },
        requires: { key: 'GreenFingers', rank: 2 } },
      { key: 'Fortune', name: 'Fortune', icon: '\u{1F48E}', maxRank: 2,
        desc: '+50 gold per level-up per rank', tier: 2, pos: { x: 70, y: 200 },
        requires: { key: 'Windfall', rank: 2 } },
      // Tier 3
      { key: 'Cornucopia', name: 'Cornucopia', icon: '\u{1F338}', maxRank: 1,
        desc: '+1 bonus crop per harvest & +1 bonus animal product',
        tier: 3, pos: { x: 50, y: 340 },
        requiresCombined: { required: { key: 'Fortune', rank: 2 }, oneOf: [{ key: 'GreenFingers', rank: 2 }, { key: 'Stockpiler', rank: 2 }] } }
    ]
  },
  legacy: {
    name: 'Legacy',
    maxPoints: 15,
    tiers: [
      { tier: 1, gate: 0, y: 60 },
      { tier: 2, gate: 3, y: 200 },
      { tier: 3, gate: 8, y: 340 }
    ],
    talents: [
      // Tier 1
      { key: 'NestEgg', name: 'Nest Egg', icon: '\u{1FA99}', maxRank: 3,
        desc: 'Start each run with rank*100*Rebirth gold', tier: 1, pos: { x: 25, y: 60 } },
      { key: 'SeedVault', name: 'Seed Vault', icon: '\u{1F331}', maxRank: 3,
        desc: 'Start each run with rank*10*Rebirth wheat seeds', tier: 1, pos: { x: 50, y: 60 } },
      { key: 'Seasoned', name: 'Seasoned', icon: '\u{1F393}', maxRank: 3,
        desc: 'Start each run with rank*Rebirth talent points', tier: 1, pos: { x: 75, y: 60 } },
      // Tier 2
      { key: 'ToolShed', name: 'Tool Shed', icon: '\u{1F527}', maxRank: 4,
        desc: 'Start with all tools at tier = rank (1-4)', tier: 2, pos: { x: 25, y: 200 },
        requires: { key: 'NestEgg', rank: 2 } },
      { key: 'RecipeTome', name: 'Recipe Tome', icon: '\u{1F4D6}', maxRank: 1,
        desc: 'Start each run with all 11 recipes unlocked', tier: 2, pos: { x: 50, y: 200 },
        requires: { key: 'SeedVault', rank: 2 } },
      // Tier 3 (no gate needed, only 2 talents in tier 2 w/ 5 max ranks)
      { key: 'QuickStart', name: 'Quick Start', icon: '\u{1F680}', maxRank: 1,
        desc: 'Start each run at Level 3 with 3 talent points', tier: 2, pos: { x: 75, y: 200 },
        requires: { key: 'Seasoned', rank: 2 } }
    ]
  }
};

// ── Game State ──
var blessingState = {};
var rebirthShards = 0;
var mysticEssence = 0;
var activeTree = 'haste';
var actionPending = false;

// Initialize all blessing ranks to 0
(function() {
  var trees = ['haste', 'abundance', 'legacy'];
  for (var t = 0; t < trees.length; t++) {
    var talents = BLESSING_TREES[trees[t]].talents;
    for (var i = 0; i < talents.length; i++) {
      blessingState[talents[i].key] = 0;
    }
  }
})();

// ── Respec System (free) ──
function getTotalInvested() {
  var total = 0;
  for (var key in blessingState) {
    total += blessingState[key] || 0;
  }
  return total;
}

function showRespecModal() {
  var refund = getTotalInvested();
  document.getElementById('respecRefund').textContent = refund;
  document.getElementById('respecModal').classList.add('visible');
}

function hideRespecModal() {
  document.getElementById('respecModal').classList.remove('visible');
}

function confirmRespec() {
  var totalInvested = getTotalInvested();
  if (totalInvested === 0) {
    hideRespecModal();
    return;
  }

  hideRespecModal();
  actionPending = true;

  // Trigger Portals to reset all RT_* to 0
  triggerTask('Respec_Rebirth_Blessings');

  // After 500ms, trigger shard refund denomination tasks staggered 350ms apart
  var refundAmount = totalInvested;
  setTimeout(function() {
    var denominations = [10, 5, 1];
    var remaining = refundAmount;
    var tasks = [];
    while (remaining > 0) {
      for (var d = 0; d < denominations.length; d++) {
        if (denominations[d] <= remaining) {
          tasks.push('Add_Rebirth_Shards_' + denominations[d]);
          remaining -= denominations[d];
          break;
        }
      }
    }
    for (var i = 0; i < tasks.length; i++) {
      (function(task, delay) {
        setTimeout(function() { triggerTask(task); }, delay);
      })(tasks[i], i * 350);
    }
  }, 500);

  // Optimistic update
  for (var key in blessingState) {
    blessingState[key] = 0;
  }
  rebirthShards += totalInvested;

  notify('Blessings reset! ' + totalInvested + ' shards refunded', 'success');
  renderAll();

  setTimeout(function() {
    actionPending = false;
    triggerTask('Sync_Inventory');
  }, 2500);
}

// ── Blessing Calculations ──
function getPointsInTree(treeName) {
  var total = 0;
  var talents = BLESSING_TREES[treeName].talents;
  for (var i = 0; i < talents.length; i++) {
    total += blessingState[talents[i].key] || 0;
  }
  return total;
}

function isTierUnlocked(treeName, gate) {
  if (gate === 0) return true;
  return getPointsInTree(treeName) >= gate;
}

function isPrereqMet(talent) {
  // Single prerequisite
  if (talent.requires) {
    if ((blessingState[talent.requires.key] || 0) < talent.requires.rank) return false;
  }
  // All prerequisites must be met
  if (talent.requiresAll) {
    for (var i = 0; i < talent.requiresAll.length; i++) {
      var req = talent.requiresAll[i];
      if ((blessingState[req.key] || 0) < req.rank) return false;
    }
  }
  // Combined: required + one-of-many
  if (talent.requiresCombined) {
    var rc = talent.requiresCombined;
    if ((blessingState[rc.required.key] || 0) < rc.required.rank) return false;
    var anyMet = false;
    for (var j = 0; j < rc.oneOf.length; j++) {
      if ((blessingState[rc.oneOf[j].key] || 0) >= rc.oneOf[j].rank) {
        anyMet = true;
        break;
      }
    }
    if (!anyMet) return false;
  }
  return true;
}

function canInvest(treeName, talent) {
  if (actionPending) return false;
  if (rebirthShards <= 0) return false;

  var tierGate = 0;
  var tiers = BLESSING_TREES[treeName].tiers;
  for (var i = 0; i < tiers.length; i++) {
    if (tiers[i].tier === talent.tier) {
      tierGate = tiers[i].gate;
      break;
    }
  }

  if (!isTierUnlocked(treeName, tierGate)) return false;
  if (!isPrereqMet(talent)) return false;

  var current = blessingState[talent.key] || 0;
  if (current >= talent.maxRank) return false;

  return true;
}

// ── Invest Point ──
function investPoint(treeName, talentKey) {
  var talent = null;
  var talents = BLESSING_TREES[treeName].talents;
  for (var i = 0; i < talents.length; i++) {
    if (talents[i].key === talentKey) {
      talent = talents[i];
      break;
    }
  }

  if (!talent) return;
  if (!canInvest(treeName, talent)) {
    if (rebirthShards <= 0) notify('No rebirth shards available', 'error');
    else if (!isPrereqMet(talent)) notify('Prerequisite not met', 'error');
    return;
  }

  actionPending = true;
  triggerTask('Invest_RT_' + talentKey);
  playSound('talent');

  // Optimistic update
  blessingState[talentKey] = (blessingState[talentKey] || 0) + 1;
  rebirthShards = Math.max(0, rebirthShards - 1);
  notify(talent.name + ' ' + blessingState[talentKey] + '/' + talent.maxRank, 'success');
  renderAll();

  setTimeout(function() {
    actionPending = false;
    triggerTask('Sync_Inventory');
  }, 1500);
}

// ── Portals SDK ──
function triggerTask(taskName, targetState) {
  targetState = targetState || 'SetNotActiveToActive';
  console.log('[Blessings] triggerTask:', taskName);
  if (typeof PortalsSdk !== 'undefined' && PortalsSdk.sendMessageToUnity) {
    PortalsSdk.sendMessageToUnity(JSON.stringify({
      TaskName: taskName,
      TaskTargetState: targetState
    }));
  }
}

function closeIframe() {
  playSound('click');
  if (typeof PortalsSdk !== 'undefined' && PortalsSdk.closeIframe) {
    PortalsSdk.closeIframe();
  }
}

// Keyboard controls
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('respecModal').classList.contains('visible')) {
      hideRespecModal();
    } else {
      closeIframe();
    }
  }
});

// ── Message Handling ──
var lastMessageId = '';
var lastMessageTime = 0;

function processMessage(msg, source) {
  if(!_uiPopPlayed){_uiPopPlayed=true;try{if(_uiPopCtx&&_uiPopBuf){if(_uiPopCtx.state==='suspended')_uiPopCtx.resume();var _s=_uiPopCtx.createBufferSource();var _g=_uiPopCtx.createGain();_s.buffer=_uiPopBuf;_g.gain.value=0.5;_s.connect(_g);_g.connect(_uiPopCtx.destination);_s.start(0)}}catch(e){}}
  var now = Date.now();
  var msgId = msg + '_' + Math.floor(now / 100);
  if (msgId === lastMessageId && now - lastMessageTime < 200) {
    return;
  }
  lastMessageId = msgId;
  lastMessageTime = now;
  handlePortalsMessage(msg);
}

function handlePortalsMessage(msg) {
  if (typeof msg !== 'string') return;
  if (msg.indexOf('Sync_Inventory') === 0) {
    if (actionPending) {
      console.log('[Blessings] Skipping stale sync while action pending');
      return;
    }
    parseAndSyncInventory(msg);
    renderAll();
    if (_firstXPSync) { _firstXPSync = false; _prevXP = _parsedXP; _prevLevel = _parsedLevel; }
    else { if (_parsedLevel === _prevLevel && _parsedXP > _prevXP) { setTimeout(function() { playSound('xp'); }, 500); } _prevXP = _parsedXP; _prevLevel = _parsedLevel; }
  }
}

var _parsedXP = 0, _parsedLevel = 0;
var _prevXP = -1, _prevLevel = -1, _firstXPSync = true;

function parseAndSyncInventory(msg) {
  msg = msg.replace('Sync_Inventory_', '');
  var parts = msg.split('_');
  var i = 0;

  // 2-word keys we care about (RT_* blessings + Rebirth_Shards + Mystic_Essence)
  var twoWordKeys = {
    'RT_FleetHarvest': 'FleetHarvest', 'RT_SwiftHusbandry': 'SwiftHusbandry',
    'RT_QuickContracts': 'QuickContracts', 'RT_RushingWinds': 'RushingWinds',
    'RT_NimbleHands': 'NimbleHands', 'RT_TimeWarp': 'TimeWarp',
    'RT_Windfall': 'Windfall', 'RT_GreenFingers': 'GreenFingers',
    'RT_Stockpiler': 'Stockpiler', 'RT_ArtisanTouch': 'ArtisanTouch',
    'RT_Fortune': 'Fortune', 'RT_Cornucopia': 'Cornucopia',
    'RT_NestEgg': 'NestEgg', 'RT_SeedVault': 'SeedVault',
    'RT_Seasoned': 'Seasoned', 'RT_ToolShed': 'ToolShed',
    'RT_RecipeTome': 'RecipeTome', 'RT_QuickStart': 'QuickStart',
    'Rebirth_Shards': '_shards', 'Mystic_Essence': '_essence',
    'Rebirth_Count': '_skip',
    'T_PlotRow2': '_skip', 'T_GreenThumb': '_skip', 'T_EagerPlanter': '_skip',
    'T_PlotRow3': '_skip', 'T_BountifulHarvest': '_skip', 'T_RapidGrowth': '_skip',
    'T_PlotRow4': '_skip', 'T_CropMastery': '_skip',
    'T_CowHerd': '_skip', 'T_ChickenFlock': '_skip', 'T_QuickHands': '_skip',
    'T_SheepPen': '_skip', 'T_GoatYard': '_skip', 'T_ApiaryExpansion': '_skip',
    'T_HusbandryKnowledge': '_skip', 'T_PigSty': '_skip', 'T_AnimalMastery': '_skip',
    'T_KeenLearner': '_skip', 'T_FarmHand': '_skip', 'T_Stockman': '_skip',
    'T_Artisan': '_skip', 'T_SeasonedWorker': '_skip', 'T_BonusPoint1': '_skip',
    'T_Prodigy': '_skip', 'T_BonusPoint2': '_skip',
    'T_Contractor1': '_skip', 'T_Contractor2': '_skip', 'T_Contractor3': '_skip',
    'Seeds_Wheat': '_skip', 'Seeds_Carrot': '_skip', 'Seeds_Corn': '_skip',
    'Seeds_Potato': '_skip', 'Seeds_Tomato': '_skip', 'Seeds_Pumpkin': '_skip',
    'Crop_Wheat': '_skip', 'Crop_Carrot': '_skip', 'Crop_Corn': '_skip',
    'Crop_Potato': '_skip', 'Crop_Tomato': '_skip', 'Crop_Pumpkin': '_skip',
    'Goat_Meat': '_skip', 'Meat_Pie': '_skip',
    'Has_Beesuit': '_skip', 'Has_Basket': '_skip',
    'Unspent_Talent_Points': '_skip',
    'Contract_1_Done': '_skip', 'Contract_2_Done': '_skip', 'Contract_3_Done': '_skip',
    'Contract_4_Done': '_skip', 'Contract_5_Done': '_skip', 'Contract_6_Done': '_skip',
    'Contract_7_Done': '_skip', 'Contract_8_Done': '_skip', 'Contract_9_Done': '_skip',
    'Contract_10_Done': '_skip'
  };

  while (i < parts.length) {
    // Four-word key
    if (i + 4 < parts.length) {
      var fourWord = parts[i] + '_' + parts[i+1] + '_' + parts[i+2] + '_' + parts[i+3];
      if (fourWord === 'Has_Recipe_Meat_Pie') { i += 5; continue; }
    }
    // Three-word key
    if (i + 3 < parts.length) {
      var threeWord = parts[i] + '_' + parts[i + 1] + '_' + parts[i + 2];
      var threeWordSkip = ['Has_Milk_Pail','Has_Shearing_Kit','Has_Butcher_Knife',
        'Has_Truffle_Spade','Has_Starter_Seeds',
        'Has_Recipe_Flour','Has_Recipe_Bread','Has_Recipe_Cheese','Has_Recipe_Stew',
        'Has_Recipe_Ragout','Has_Recipe_Pie','Has_Recipe_Blanket','Has_Recipe_Butter',
        'Has_Recipe_Cake','Has_Recipe_Mead',
        'Unspent_Talent_Points','Contract_1_Done','Contract_2_Done','Contract_3_Done',
        'Contract_4_Done','Contract_5_Done','Contract_6_Done','Contract_7_Done',
        'Contract_8_Done','Contract_9_Done','Contract_10_Done'];
      if (threeWordSkip.indexOf(threeWord) !== -1) { i += 4; continue; }
    }
    // Two-word key
    if (i + 2 < parts.length) {
      var twoWord = parts[i] + '_' + parts[i + 1];
      if (twoWordKeys[twoWord] !== undefined) {
        var v = parseInt(parts[i + 2]);
        var val = isNaN(v) ? 0 : v;
        var target = twoWordKeys[twoWord];
        if (target === '_shards') {
          rebirthShards = val;
        } else if (target === '_essence') {
          mysticEssence = val;
        } else if (target !== '_skip') {
          blessingState[target] = val;
        }
        i += 3; continue;
      }
    }
    // One-word keys
    if (parts[i] === 'XP' && i + 1 < parts.length) {
      var xv = parseInt(parts[i + 1]);
      _parsedXP = isNaN(xv) ? 0 : Math.max(0, xv);
      i += 2; continue;
    }
    if (parts[i] === 'Level' && i + 1 < parts.length) {
      var lv = parseInt(parts[i + 1]);
      _parsedLevel = isNaN(lv) ? 0 : Math.max(0, lv);
      i += 2; continue;
    }
    if (parts[i] === 'playerName' && i + 1 < parts.length) { i += 2; continue; }
    i++;
  }
}

function setupMessageListener() {
  if (typeof PortalsSdk !== 'undefined' && PortalsSdk.setMessageListener) {
    PortalsSdk.setMessageListener(function(msg) {
      processMessage(msg, 'SDK');
    });
    console.log('[Blessings] SDK listener registered');
  } else {
    setTimeout(setupMessageListener, 200);
  }
}

window.addEventListener('message', function(event) {
  if (event.data && typeof event.data === 'string') {
    processMessage(event.data, 'postMessage-string');
  }
  else if (event.data && event.data.portalsMessage) {
    processMessage(event.data.portalsMessage, 'postMessage-portals');
  }
  else if (event.data && event.data.message && typeof event.data.message === 'string') {
    processMessage(event.data.message, 'postMessage-message');
  }
});

setupMessageListener();
setTimeout(function() { triggerTask('Sync_Inventory'); }, 500);

// ── Visibility/Focus Handlers ──
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) { triggerTask('Sync_Inventory'); }
});
window.addEventListener('focus', function() {
  triggerTask('Sync_Inventory');
});

// ── UI Rendering ──
function switchTree(treeName) {
  activeTree = treeName;
  var tabs = document.querySelectorAll('.tree-tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.toggle('active', tabs[i].getAttribute('data-tree') === treeName);
  }
  renderTree();
}

function renderAll() {
  // Shards badge
  document.getElementById('shardsBadge').textContent = rebirthShards + (rebirthShards === 1 ? ' Shard' : ' Shards');

  // Essence badge
  document.getElementById('essenceBadge').innerHTML = '&#10024; ' + mysticEssence;

  // Respec button
  var respecBtn = document.getElementById('respecBtn');
  var totalInvested = getTotalInvested();
  if (totalInvested > 0 && !actionPending) {
    respecBtn.disabled = false;
    respecBtn.innerHTML = '<span>&#128260;</span> Respec (Free)';
  } else {
    respecBtn.disabled = true;
    respecBtn.innerHTML = '<span>&#128260;</span> Respec';
  }

  // Tab point counters
  document.getElementById('tabPointsHaste').textContent = getPointsInTree('haste') + ' / 15';
  document.getElementById('tabPointsAbundance').textContent = getPointsInTree('abundance') + ' / 15';
  document.getElementById('tabPointsLegacy').textContent = getPointsInTree('legacy') + ' / 15';

  renderTree();
}

function renderTree() {
  var tree = BLESSING_TREES[activeTree];
  var container = document.getElementById('treeCanvas');
  var treePoints = getPointsInTree(activeTree);

  // Calculate canvas height
  var maxY = 0;
  for (var t = 0; t < tree.talents.length; t++) {
    if (tree.talents[t].pos.y > maxY) maxY = tree.talents[t].pos.y;
  }
  container.style.minHeight = (maxY + 100) + 'px';

  var html = '';

  // SVG for connecting lines
  html += '<svg class="tree-lines" viewBox="0 0 100 ' + (maxY + 100) + '" preserveAspectRatio="none">';

  for (var i = 0; i < tree.talents.length; i++) {
    var talent = tree.talents[i];
    var prereqs = [];

    if (talent.requires) prereqs.push(talent.requires);
    if (talent.requiresAll) prereqs = prereqs.concat(talent.requiresAll);
    if (talent.requiresCombined) {
      prereqs.push(talent.requiresCombined.required);
      prereqs = prereqs.concat(talent.requiresCombined.oneOf);
    }

    for (var p = 0; p < prereqs.length; p++) {
      var prereq = prereqs[p];
      var prereqTalent = null;
      for (var j = 0; j < tree.talents.length; j++) {
        if (tree.talents[j].key === prereq.key) {
          prereqTalent = tree.talents[j];
          break;
        }
      }

      if (prereqTalent) {
        var lineClass = 'tree-line';
        var prereqRank = blessingState[prereq.key] || 0;
        var talentRank = blessingState[talent.key] || 0;

        if (talentRank >= talent.maxRank) {
          lineClass += ' maxed';
        } else if (prereqRank >= prereq.rank) {
          lineClass += ' unlocked';
        }

        var x1 = prereqTalent.pos.x;
        var y1 = prereqTalent.pos.y + 4;
        var x2 = talent.pos.x;
        var y2 = talent.pos.y - 4;
        var midY = (y1 + y2) / 2;

        html += '<path class="' + lineClass + '" d="M' + x1 + ',' + y1 +
                ' C' + x1 + ',' + midY + ' ' + x2 + ',' + midY + ' ' + x2 + ',' + y2 + '"/>';
      }
    }
  }

  html += '</svg>';

  // Tier labels
  for (var ti = 0; ti < tree.tiers.length; ti++) {
    var tierData = tree.tiers[ti];
    var tierUnlocked = isTierUnlocked(activeTree, tierData.gate);
    var labelText = 'Tier ' + tierData.tier;
    if (tierData.gate > 0) {
      labelText += ' (' + tierData.gate + ' pts)';
    }
    html += '<div class="tier-label' + (tierUnlocked ? ' unlocked' : '') + '" style="top:' + (tierData.y - 30) + 'px">' + labelText + '</div>';
  }

  // Render nodes
  for (var n = 0; n < tree.talents.length; n++) {
    var talent = tree.talents[n];
    var currentRank = blessingState[talent.key] || 0;
    var isMaxed = currentRank >= talent.maxRank;

    var tierGate = 0;
    for (var ti = 0; ti < tree.tiers.length; ti++) {
      if (tree.tiers[ti].tier === talent.tier) {
        tierGate = tree.tiers[ti].gate;
        break;
      }
    }
    var tierUnlocked = isTierUnlocked(activeTree, tierGate);
    var prereqMet = isPrereqMet(talent);

    var nodeClass = 'talent-node';
    if (isMaxed) nodeClass += ' maxed';
    else if (canInvest(activeTree, talent)) nodeClass += ' available';
    else if (currentRank > 0) nodeClass += ' invested';
    else if (!tierUnlocked || !prereqMet) nodeClass += ' locked';

    html += '<div class="' + nodeClass + '" style="left:' + talent.pos.x + '%;top:' + talent.pos.y + 'px" ' +
            'onclick="investPoint(\'' + activeTree + '\',\'' + talent.key + '\')" ' +
            'onmouseenter="showTooltip(event,\'' + activeTree + '\',\'' + talent.key + '\')" ' +
            'onmouseleave="hideTooltip()" ' +
            'ontouchstart="showTooltip(event,\'' + activeTree + '\',\'' + talent.key + '\')">';
    html += '<div class="node-circle">' + talent.icon + '<div class="node-rank">' + currentRank + '/' + talent.maxRank + '</div></div>';
    html += '<div class="node-name">' + talent.name + '</div>';
    html += '</div>';
  }

  container.innerHTML = html;
}

// ── Tooltip ──
function showTooltip(event, treeName, talentKey) {
  var talent = null;
  var talents = BLESSING_TREES[treeName].talents;
  for (var i = 0; i < talents.length; i++) {
    if (talents[i].key === talentKey) {
      talent = talents[i];
      break;
    }
  }
  if (!talent) return;

  var currentRank = blessingState[talent.key] || 0;
  var tooltip = document.getElementById('tooltip');

  var html = '<div class="tooltip-header">';
  html += '<span class="tooltip-icon">' + talent.icon + '</span>';
  html += '<span class="tooltip-title">' + talent.name + '</span>';
  html += '</div>';
  html += '<div class="tooltip-rank">Rank: ' + currentRank + ' / ' + talent.maxRank + '</div>';
  html += '<div class="tooltip-desc">' + talent.desc + '</div>';

  // Show prerequisite info
  if (talent.requires) {
    var prereqRank = blessingState[talent.requires.key] || 0;
    var met = prereqRank >= talent.requires.rank;
    var prereqName = talent.requires.key;
    for (var j = 0; j < talents.length; j++) {
      if (talents[j].key === talent.requires.key) { prereqName = talents[j].name; break; }
    }
    html += '<div class="tooltip-prereq' + (met ? ' met' : '') + '">';
    html += (met ? '&#10003; ' : '&#10007; ') + 'Requires: ' + prereqName + ' ' + prereqRank + '/' + talent.requires.rank;
    html += '</div>';
  }

  if (talent.requiresAll) {
    var allMet = true;
    var prereqText = 'Requires ALL: ';
    for (var k = 0; k < talent.requiresAll.length; k++) {
      var req = talent.requiresAll[k];
      var rRank = blessingState[req.key] || 0;
      if (rRank < req.rank) allMet = false;
      var rName = req.key;
      for (var j = 0; j < talents.length; j++) {
        if (talents[j].key === req.key) { rName = talents[j].name; break; }
      }
      if (k > 0) prereqText += ' AND ';
      prereqText += rName + ' ' + rRank + '/' + req.rank;
    }
    html += '<div class="tooltip-prereq' + (allMet ? ' met' : '') + '">';
    html += (allMet ? '&#10003; ' : '&#10007; ') + prereqText;
    html += '</div>';
  }

  if (talent.requiresCombined) {
    var rc = talent.requiresCombined;
    var reqMet = (blessingState[rc.required.key] || 0) >= rc.required.rank;
    var anyOneOfMet = false;
    var reqName = rc.required.key;
    for (var j = 0; j < talents.length; j++) {
      if (talents[j].key === rc.required.key) { reqName = talents[j].name; break; }
    }
    html += '<div class="tooltip-prereq' + (reqMet ? ' met' : '') + '">';
    html += (reqMet ? '&#10003; ' : '&#10007; ') + 'Requires: ' + reqName + ' ' + (blessingState[rc.required.key] || 0) + '/' + rc.required.rank;
    html += '</div>';

    var oneOfText = 'Plus one of: ';
    for (var k = 0; k < rc.oneOf.length; k++) {
      var req = rc.oneOf[k];
      var rRank = blessingState[req.key] || 0;
      if (rRank >= req.rank) anyOneOfMet = true;
      var rName = req.key;
      for (var j = 0; j < talents.length; j++) {
        if (talents[j].key === req.key) { rName = talents[j].name; break; }
      }
      if (k > 0) oneOfText += ' OR ';
      oneOfText += rName + ' ' + rRank + '/' + req.rank;
    }
    html += '<div class="tooltip-prereq' + (anyOneOfMet ? ' met' : '') + '">';
    html += (anyOneOfMet ? '&#10003; ' : '&#10007; ') + oneOfText;
    html += '</div>';
  }

  // Tier info
  var tierGate = 0;
  for (var ti = 0; ti < BLESSING_TREES[treeName].tiers.length; ti++) {
    if (BLESSING_TREES[treeName].tiers[ti].tier === talent.tier) {
      tierGate = BLESSING_TREES[treeName].tiers[ti].gate;
      break;
    }
  }
  if (tierGate > 0) {
    var tierUnlocked = isTierUnlocked(treeName, tierGate);
    html += '<div class="tooltip-tier">' + (tierUnlocked ? '&#10003;' : '&#10007;') + ' Tier ' + talent.tier + ' requires ' + tierGate + ' points in tree</div>';
  }

  tooltip.innerHTML = html;

  // Position off-screen first to measure actual dimensions
  tooltip.style.left = '-9999px';
  tooltip.style.top = '-9999px';
  tooltip.classList.add('visible');

  var rect = event.target.getBoundingClientRect();
  var tw = tooltip.offsetWidth;
  var th = tooltip.offsetHeight;
  var x = rect.right + 10;
  var y = rect.top;

  if (x + tw > window.innerWidth - 10) { x = rect.left - tw - 10; }
  if (x < 10) x = 10;
  if (y + th > window.innerHeight - 10) { y = window.innerHeight - th - 10; }
  if (y < 10) y = 10;

  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').classList.remove('visible');
}

// ── Sound Effects ──
var _mp3Sounds = {};
(function() {
  var files = { purchase: 'purchase.mp3', harvest: 'harvest.mp3', craft: 'harvest.mp3', levelup: 'levelup.mp3', click: 'click.mp3', talent: 'talent.mp3', xp: 'xp-gain.mp3' };
  for (var k in files) { var a = new Audio(files[k]); a.preload = 'auto'; a.volume = (k === 'click' || k === 'talent') ? 0.6 : 0.3; _mp3Sounds[k] = a; }
})();
var _audioCtx = null;
function _getAudioCtx() {
  if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  return _audioCtx;
}
function playSound(type) {
  try {
    if (_mp3Sounds[type]) { _mp3Sounds[type].currentTime = 0; _mp3Sounds[type].play().catch(function(){}); return; }
    var ctx = _getAudioCtx(); var g = ctx.createGain(); g.connect(ctx.destination); var t = ctx.currentTime;
    if (type === 'success') {
      var o = ctx.createOscillator(); o.type = 'sine'; o.connect(g);
      o.frequency.setValueAtTime(523, t); o.frequency.setValueAtTime(659, t + 0.1);
      g.gain.setValueAtTime(0.18, t); g.gain.linearRampToValueAtTime(0, t + 0.2);
      o.start(t); o.stop(t + 0.2);
    } else if (type === 'error') {
      var o = ctx.createOscillator(); o.type = 'square'; o.connect(g);
      o.frequency.setValueAtTime(180, t);
      g.gain.setValueAtTime(0.15, t); g.gain.linearRampToValueAtTime(0, t + 0.15);
      o.start(t); o.stop(t + 0.15);
    }
  } catch (e) {}
}

var notifCount = 0;
function notify(msg, type) {
  type = type || 'success';
  playSound(type);
  var container = document.getElementById('notifications');
  while (container.children.length >= 5) {
    container.removeChild(container.firstChild);
  }
  var notif = document.createElement('div');
  notif.className = 'notification ' + (type === 'success' || type === 'error' ? type : 'success');
  notif.textContent = msg;
  container.appendChild(notif);
  setTimeout(function() { if (notif.parentNode) notif.remove(); }, 3000);
}

// Initial render
renderAll();
</script>
</body>
</html>
