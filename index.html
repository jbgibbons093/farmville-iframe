<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmville</title>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: rgba(0,0,0,0.85); min-height: 100vh; color: #fff; overflow: hidden; }

    .overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .menu-container { width: 100%; max-width: 1100px; height: 85vh; max-height: 750px; background: linear-gradient(145deg, #2d1f0f 0%, #1a1208 100%); border: 4px solid #8B4513; border-radius: 20px; box-shadow: 0 0 0 2px #5a3a1a, 0 20px 60px rgba(0,0,0,0.8), inset 0 2px 0 rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.4s ease; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .menu-header { background: linear-gradient(180deg, #4a3520 0%, #2d1f10 100%); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #8B4513; }
    .game-title { font-family: 'Luckiest Guy', cursive; font-size: 28px; color: #FFD700; text-shadow: 2px 2px 0 #8B4513, 4px 4px 8px rgba(0,0,0,0.5); letter-spacing: 2px; }
    .header-stats { display: flex; gap: 20px; align-items: center; }
    .stat-box { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.4); padding: 6px 12px; border-radius: 8px; border: 2px solid #5a4030; }
    .stat-icon { font-size: 20px; }
    .stat-value { font-size: 18px; font-weight: 800; color: #FFD700; }
    .stat-label { font-size: 10px; color: #aaa; text-transform: uppercase; }
    .xp-bar-bg { width: 100px; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; border: 1px solid #5a4030; }
    .xp-bar-fill { height: 100%; background: linear-gradient(90deg, #4a90d9, #67b8f7); transition: width 0.5s ease; }
    .close-btn { background: linear-gradient(180deg, #c0392b 0%, #96281b 100%); border: 2px solid #e74c3c; color: #fff; width: 40px; height: 40px; border-radius: 10px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 3px 0 #7a1f14; }
    .close-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 0 #7a1f14; }

    .nav-tabs { display: flex; background: rgba(0,0,0,0.3); border-bottom: 2px solid #5a4030; }
    .nav-tab { flex: 1; padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.2s; border-right: 1px solid #3a2a1a; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .nav-tab:last-child { border-right: none; }
    .nav-tab:hover { background: rgba(139, 69, 19, 0.3); }
    .nav-tab.active { background: linear-gradient(180deg, #5a4020 0%, #3a2810 100%); border-bottom: 3px solid #FFD700; margin-bottom: -2px; }
    .nav-tab-icon { font-size: 24px; }
    .nav-tab-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
    .nav-tab.active .nav-tab-label { color: #FFD700; }

    .content-area { flex: 1; overflow-y: auto; padding: 20px; }
    .tab-content { display: none; animation: fadeInContent 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .section-title { font-size: 18px; font-weight: 700; color: #FFD700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .section-title::after { content: ''; flex: 1; height: 2px; background: linear-gradient(90deg, #5a4530, transparent); }

    /* Dashboard */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .dashboard-card { background: linear-gradient(145deg, rgba(60, 45, 30, 0.8) 0%, rgba(40, 30, 20, 0.8) 100%); border: 2px solid #5a4530; border-radius: 12px; padding: 15px; }
    .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #5a4530; }
    .card-icon { font-size: 28px; }
    .card-title { font-size: 16px; font-weight: 700; color: #FFD700; }
    .quick-stats { display: flex; flex-wrap: wrap; gap: 8px; }
    .quick-stat { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 6px; flex: 1; min-width: 80px; }
    .quick-stat-icon { font-size: 18px; }
    .quick-stat-value { font-size: 16px; font-weight: 700; }
    .quick-stat-label { font-size: 10px; color: #888; }

    /* Crops */
    .crops-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
    .crops-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 8px; }
    .control-label { font-size: 12px; color: #ccc; font-weight: 600; }
    .toggle-switch { position: relative; width: 44px; height: 24px; background: #4a4a4a; border-radius: 12px; cursor: pointer; transition: background 0.3s; }
    .toggle-switch.on { background: #27ae60; }
    .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .toggle-switch.on::after { transform: translateX(20px); }
    select { background: #3a3020; border: 2px solid #5a4530; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .action-btn { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); border: 2px solid #2ecc71; color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 3px 0 #196f3d; }
    .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 0 #196f3d; }
    .action-btn.secondary { background: linear-gradient(180deg, #8B4513 0%, #5a2d0a 100%); border-color: #a0522d; box-shadow: 0 3px 0 #3d1f08; }

    .crops-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
    @media (max-width: 800px) { .crops-grid { grid-template-columns: repeat(4, 1fr); } }
    .plot-card { background: linear-gradient(145deg, rgba(50, 40, 25, 0.9) 0%, rgba(35, 28, 18, 0.9) 100%); border: 2px solid #4a3a2a; border-radius: 10px; padding: 10px; text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; position: relative; transition: all 0.2s; }
    .plot-card.empty { border-color: #3a3a3a; background: linear-gradient(145deg, rgba(40,40,40,0.7) 0%, rgba(30,30,30,0.7) 100%); }
    .plot-card.growing { border-color: #27ae60; }
    .plot-card.ready { border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.4); animation: pulseGold 2s infinite; }
    @keyframes pulseGold { 0%, 100% { box-shadow: 0 0 15px rgba(255,215,0,0.4); } 50% { box-shadow: 0 0 25px rgba(255,215,0,0.7); } }
    .plot-number { position: absolute; top: 4px; left: 6px; font-size: 10px; color: #666; font-weight: 700; }
    .plot-icon { font-size: 32px; margin: 6px 0; }
    .plot-name { font-size: 12px; font-weight: 700; }
    .plot-status { font-size: 10px; color: #888; margin: 4px 0; }
    .plot-status.ready { color: #FFD700; font-weight: 700; }
    .plot-progress { height: 5px; background: rgba(0,0,0,0.4); border-radius: 3px; overflow: hidden; margin: 4px 0; }
    .plot-progress-fill { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); transition: width 0.5s ease; }
    .plot-btn { background: linear-gradient(180deg, #5a4020 0%, #3a2810 100%); border: 2px solid #8B4513; color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: 700; cursor: pointer; width: 100%; }
    .plot-btn:hover { background: linear-gradient(180deg, #7a5a30 0%, #5a3820 100%); }
    .plot-btn.harvest { background: linear-gradient(180deg, #f39c12 0%, #d68910 100%); border-color: #f1c40f; }
    .plot-select { width: 100%; padding: 4px; font-size: 10px; margin-bottom: 4px; background: #2a2015; border: 1px solid #5a4530; color: #fff; border-radius: 4px; }

    /* Inventory */
    .inventory-section { margin-bottom: 25px; }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
    .inv-item { background: linear-gradient(145deg, rgba(50, 40, 25, 0.8) 0%, rgba(35, 28, 18, 0.8) 100%); border: 2px solid #4a3a2a; border-radius: 10px; padding: 12px 8px; text-align: center; transition: all 0.2s; }
    .inv-item:hover { border-color: #8B4513; transform: translateY(-2px); }
    .inv-item.zero { opacity: 0.4; }
    .inv-icon { font-size: 28px; margin-bottom: 6px; }
    .inv-name { font-size: 10px; color: #aaa; margin-bottom: 4px; }
    .inv-qty { font-size: 16px; font-weight: 800; color: #FFD700; }

    /* Market */
    .market-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
    .market-tab { flex: 1; padding: 10px; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid #4a3a2a; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; transition: all 0.2s; }
    .market-tab:hover { background: rgba(139, 69, 19, 0.3); }
    .market-tab.active { background: linear-gradient(180deg, #5a4020 0%, #3a2810 100%); border-color: #FFD700; color: #FFD700; }
    .market-section { display: none; }
    .market-section.active { display: block; }
    .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .market-item { background: linear-gradient(145deg, rgba(50, 40, 25, 0.8) 0%, rgba(35, 28, 18, 0.8) 100%); border: 2px solid #4a3a2a; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; }
    .market-item-icon { font-size: 36px; }
    .market-item-info { flex: 1; }
    .market-item-name { font-size: 14px; font-weight: 700; }
    .market-item-stock { font-size: 11px; color: #888; margin-top: 2px; }
    .market-item-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .market-price { font-size: 16px; font-weight: 800; color: #FFD700; }
    .market-btn { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); border: 2px solid #2ecc71; color: #fff; padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; }
    .market-btn:hover:not(:disabled) { transform: scale(1.05); }
    .market-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .market-btn.sell { background: linear-gradient(180deg, #e67e22 0%, #d35400 100%); border-color: #f39c12; }

    /* Crafting */
    .crafting-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
    .recipe-card { background: linear-gradient(145deg, rgba(50, 40, 25, 0.9) 0%, rgba(35, 28, 18, 0.9) 100%); border: 2px solid #4a3a2a; border-radius: 12px; padding: 15px; }
    .recipe-card.craftable { border-color: #27ae60; }
    .recipe-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .recipe-name { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .recipe-icon { font-size: 24px; }
    .recipe-value { text-align: right; }
    .recipe-price { font-size: 16px; font-weight: 800; color: #FFD700; }
    .recipe-xp { font-size: 11px; color: #67b8f7; }
    .recipe-ingredients { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .ingredient { background: rgba(0,0,0,0.4); padding: 6px 10px; border-radius: 6px; font-size: 12px; display: flex; align-items: center; gap: 5px; border: 1px solid #4a3a2a; }
    .ingredient.has { border-color: #27ae60; color: #2ecc71; }
    .ingredient.missing { border-color: #c0392b; color: #e74c3c; }
    .craft-btn { width: 100%; background: linear-gradient(180deg, #8B4513 0%, #5a2d0a 100%); border: 2px solid #a0522d; color: #fff; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; }
    .craft-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .craft-btn.ready { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); border-color: #2ecc71; }

    /* Animals */
    .animals-section { margin-bottom: 25px; }
    .animals-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .animal-card { background: linear-gradient(145deg, rgba(50, 40, 25, 0.8) 0%, rgba(35, 28, 18, 0.8) 100%); border: 2px solid #4a3a2a; border-radius: 10px; padding: 12px; text-align: center; }
    .animal-card.ready { border-color: #FFD700; box-shadow: 0 0 12px rgba(255,215,0,0.3); }
    .animal-icon { font-size: 40px; margin-bottom: 8px; }
    .animal-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .animal-status { font-size: 12px; margin-bottom: 8px; }
    .animal-status.ready { color: #2ecc71; font-weight: 700; }
    .animal-status.cooldown { color: #f39c12; }
    .animal-btn { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); border: 2px solid #2ecc71; color: #fff; padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; }
    .animal-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #4a4a4a; border-color: #666; }

    .menu-footer { background: rgba(0,0,0,0.4); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #5a4030; }
    .footer-hint { font-size: 12px; color: #888; }
    .footer-hint kbd { background: #4a3a2a; padding: 2px 6px; border-radius: 4px; margin: 0 2px; font-family: monospace; }

    .notifications { position: fixed; bottom: 80px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .notification { background: rgba(30, 25, 15, 0.95); border: 2px solid #8B4513; border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 10px; animation: notifSlide 0.3s ease, notifFade 0.5s ease 2.5s forwards; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .notification.success { border-color: #27ae60; }
    .notification.error { border-color: #c0392b; }
    .notification-icon { font-size: 20px; }
    .notification-text { font-size: 14px; font-weight: 600; }
    @keyframes notifSlide { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes notifFade { to { opacity: 0; transform: translateY(-20px); } }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #5a4530; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="menu-container">
      <div class="menu-header">
        <div class="game-title">FARMVILLE</div>
        <div class="header-stats">
          <div class="stat-box"><span class="stat-icon">&#x1F4B0;</span><div><div class="stat-value" id="header-gold">100</div><div class="stat-label">Gold</div></div></div>
          <div class="stat-box"><span class="stat-icon">&#x2B50;</span><div><div class="stat-value">Lv.<span id="header-level">1</span></div><div class="xp-bar-bg"><div class="xp-bar-fill" id="header-xp-bar" style="width:0%"></div></div></div></div>
        </div>
        <button class="close-btn" onclick="closeMenu()" title="Close (Tab)">&#x2715;</button>
      </div>
      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard"><span class="nav-tab-icon">&#x1F3E0;</span><span class="nav-tab-label">Home</span></div>
        <div class="nav-tab" data-tab="crops"><span class="nav-tab-icon">&#x1F33E;</span><span class="nav-tab-label">Crops</span></div>
        <div class="nav-tab" data-tab="inventory"><span class="nav-tab-icon">&#x1F392;</span><span class="nav-tab-label">Items</span></div>
        <div class="nav-tab" data-tab="market"><span class="nav-tab-icon">&#x1F3EA;</span><span class="nav-tab-label">Market</span></div>
        <div class="nav-tab" data-tab="crafting"><span class="nav-tab-icon">&#x2692;&#xFE0F;</span><span class="nav-tab-label">Craft</span></div>
        <div class="nav-tab" data-tab="animals"><span class="nav-tab-icon">&#x1F404;</span><span class="nav-tab-label">Animals</span></div>
      </div>
      <div class="content-area">
        <div class="tab-content active" id="tab-dashboard"></div>
        <div class="tab-content" id="tab-crops"></div>
        <div class="tab-content" id="tab-inventory"></div>
        <div class="tab-content" id="tab-market"></div>
        <div class="tab-content" id="tab-crafting"></div>
        <div class="tab-content" id="tab-animals"></div>
      </div>
      <div class="menu-footer">
        <div class="footer-hint">Press <kbd>Tab</kbd> to close | <kbd>1-6</kbd> Quick nav</div>
        <button class="action-btn secondary" onclick="saveGame()">&#x1F4BE; Save</button>
      </div>
    </div>
  </div>
  <div class="notifications" id="notifications"></div>

  <script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js"></script>
  <script>
    const CONFIG = {
      crops: {
        wheat: { id: 1, name: 'Wheat', icon: '&#x1F33E;', growTime: 30, yield: 3, sellPrice: 5, seedCost: 2, unlockLevel: 1 },
        corn: { id: 2, name: 'Corn', icon: '&#x1F33D;', growTime: 45, yield: 3, sellPrice: 8, seedCost: 3, unlockLevel: 1 },
        carrots: { id: 3, name: 'Carrots', icon: '&#x1F955;', growTime: 60, yield: 4, sellPrice: 10, seedCost: 5, unlockLevel: 2 },
        tomatoes: { id: 4, name: 'Tomatoes', icon: '&#x1F345;', growTime: 90, yield: 4, sellPrice: 15, seedCost: 8, unlockLevel: 3 },
        potatoes: { id: 5, name: 'Potatoes', icon: '&#x1F954;', growTime: 75, yield: 5, sellPrice: 12, seedCost: 6, unlockLevel: 2 },
        pumpkins: { id: 6, name: 'Pumpkins', icon: '&#x1F383;', growTime: 120, yield: 2, sellPrice: 30, seedCost: 15, unlockLevel: 5 }
      },
      animals: { cow: { name: 'Cow', icon: '&#x1F404;', product: 'milk', cooldown: 90, count: 3 }, sheep: { name: 'Sheep', icon: '&#x1F411;', product: 'wool', cooldown: 120, count: 3 }, pig: { name: 'Pig', icon: '&#x1F437;', product: 'fertilizer', cooldown: 0, count: 3 } },
      hives: { count: 9, cooldown: 180 },
      recipes: [
        { id: 'bread', name: 'Bread', icon: '&#x1F35E;', ingredients: { flour: 3, milk: 1 }, sellPrice: 35, xp: 15 },
        { id: 'cheese', name: 'Cheese', icon: '&#x1F9C0;', ingredients: { milk: 5 }, sellPrice: 45, xp: 20 },
        { id: 'stew', name: 'Veg Stew', icon: '&#x1F372;', ingredients: { carrots: 2, potatoes: 2, tomatoes: 1 }, sellPrice: 50, xp: 25 },
        { id: 'pie', name: 'Pumpkin Pie', icon: '&#x1F967;', ingredients: { pumpkins: 2, flour: 2, milk: 1 }, sellPrice: 100, xp: 40 },
        { id: 'mead', name: 'Mead', icon: '&#x1F37A;', ingredients: { honey: 3, wheat: 1 }, sellPrice: 100, xp: 35 },
        { id: 'blanket', name: 'Wool Blanket', icon: '&#x1F9E3;', ingredients: { wool: 5 }, sellPrice: 60, xp: 20 }
      ],
      equipment: [
        { id: 'beesuit', name: 'Bee Suit', icon: '&#x1F41D;', price: 500, desc: 'No bee sting damage' },
        { id: 'basket', name: 'Harvest Basket', icon: '&#x1F9FA;', price: 300, desc: '+50% crop yield' }
      ],
      levelThresholds: [0, 100, 300, 600, 1000, 1500, 2200, 3000, 4000, 5500]
    };

    let gameState = {
      gold: 100, xp: 0, level: 1,
      inventory: { wheat: 0, corn: 0, carrots: 0, tomatoes: 0, potatoes: 0, pumpkins: 0, seeds_wheat: 5, seeds_corn: 3, seeds_carrots: 0, seeds_tomatoes: 0, seeds_potatoes: 0, seeds_pumpkins: 0, milk: 0, wool: 0, fertilizer: 0, honey: 0, flour: 0, bread: 0, cheese: 0, stew: 0, pie: 0, mead: 0, blanket: 0 },
      equipment: { beesuit: false, basket: false },
      plots: [], animals: { cows: [], sheep: [], pigs: [] }, hives: [],
      settings: { autoReplant: false, priorityCrop: 'wheat' }
    };

    for (let i = 0; i < 24; i++) gameState.plots.push({ id: i + 1, state: 'empty', cropType: null, plantedAt: null, readyAt: null });
    for (let i = 0; i < 3; i++) { gameState.animals.cows.push({ id: i + 1, readyAt: Date.now(), notified: false }); gameState.animals.sheep.push({ id: i + 1, readyAt: Date.now(), notified: false }); gameState.animals.pigs.push({ id: i + 1, readyAt: Date.now(), notified: false }); }
    for (let i = 0; i < 9; i++) gameState.hives.push({ id: i + 1, readyAt: Date.now(), notified: false });

    // Trigger a Portals task
    function triggerTask(taskName, targetState = 'SetNotActiveToActive') {
      if (typeof PortalsSdk !== 'undefined' && PortalsSdk.sendMessageToUnity) {
        PortalsSdk.sendMessageToUnity(JSON.stringify({
          TaskName: taskName,
          TaskTargetState: targetState
        }));
      }
      console.log('Trigger Task:', taskName, targetState);
    }

    // Legacy functions - now just log (Portals handles show/hide via tasks)
    function sendToPortals(cmd) { console.log('To Portals:', cmd); }
    function closeMenu() { console.log('Close menu requested'); }
    function setVariable(n, v) { console.log('Set variable:', n, v); }
    function showObject(n) { console.log('Show object:', n); }
    function hideObject(n) { console.log('Hide object:', n); }
    function playSound(s) { console.log('Play sound:', s); }

    // Set up Portals message listener (same pattern as working TDM leaderboard)
    if (typeof PortalsSdk !== 'undefined' && PortalsSdk.setMessageListener) {
      PortalsSdk.setMessageListener(handlePortalsMessage);
      console.log('[Farmville] SDK listener registered');
    } else {
      window.addEventListener('message', (e) => handlePortalsMessage(e.data));
      console.log('[Farmville] Using fallback listener');
    }

    function handlePortalsMessage(msg) {
      console.log('[Farmville] Received:', msg);
      if (typeof msg !== 'string') return;
      const parts = msg.split('_');
      const cmd = parts[0];

      // Init message: init_gold_level_xp
      if (cmd === 'init') {
        if (parts.length >= 4) {
          gameState.gold = parseInt(parts[1]) || 100;
          gameState.level = parseInt(parts[2]) || 1;
          gameState.xp = parseInt(parts[3]) || 0;
        }
        loadFromStorage();
        updateAllUI();
      }
      // Interact with plot: interact_plot_1
      else if (cmd === 'interact' && parts[1] === 'plot') {
        const plotId = parseInt(parts[2]);
        console.log('Interact with plot', plotId, 'local state:', gameState.plots[plotId - 1].state);
        // Trust Portals - if we got interact message, the crop is ready (Portals verified via state variable)
        harvestPlotFromTrigger(plotId);
      }
      // Interact with animal: interact_cow_1
      else if (cmd === 'interact') {
        const animalType = parts[1];
        const id = parseInt(parts[2]);
        if (animalType === 'cow') collectFromCow(id);
        else if (animalType === 'sheep') collectFromSheep(id);
        else if (animalType === 'pig') collectFromPig(id);
        else if (animalType === 'chicken') collectFromChicken(id);
        else if (animalType === 'beehive') collectFromHive(id);
      }
      // Confirmations from Portals
      else if (cmd === 'plant' && parts[1] === 'confirmed') {
        const plotId = parseInt(parts[2]);
        console.log('Plant confirmed for plot', plotId);
      }
      else if (cmd === 'crop' && parts[1] === 'ready') {
        const plotId = parseInt(parts[2]);
        const plot = gameState.plots[plotId - 1];
        if (plot.state === 'growing') {
          plot.state = 'ready';
          notify(`Plot ${plotId} is ready to harvest!`, 'success');
          renderCrops();
        }
      }
      else if (cmd === 'harvest' && parts[1] === 'complete') {
        const plotId = parseInt(parts[2]);
        console.log('Harvest confirmed for plot', plotId);
      }
    }

    // Harvest triggered by 3D trigger cube (from Portals interact message)
    function harvestPlotFromTrigger(plotId) {
      const plot = gameState.plots[plotId - 1];
      console.log('harvestPlotFromTrigger called for plot', plotId, 'cropType:', plot.cropType, 'state:', plot.state);

      // Tell Portals to run the harvest task (Move Item, reset variables, etc.)
      triggerTask(`Harvest_Plot_${plotId}`, 'SetNotActiveToActive');

      // Get crop info - use stored cropType or default to wheat for testing
      const cropType = plot.cropType || 'wheat';
      const crop = CONFIG.crops[cropType];

      if (!crop) {
        console.log('No crop found, using wheat as default');
        notify('+3 Wheat! (harvested)', 'success');
        gameState.inventory.wheat += 3;
      } else {
        let amount = crop.yield;
        if (gameState.equipment.basket) amount = Math.floor(amount * 1.5);
        gameState.inventory[cropType] += amount;
        notify(`+${amount} ${crop.name}!`, 'success');
        console.log('Harvested', amount, crop.name);
      }

      addXP(5);

      // Reset plot state
      plot.state = 'empty';
      plot.cropType = null;
      plot.plantedAt = null;
      plot.readyAt = null;

      // Auto-replant if enabled
      if (gameState.settings.autoReplant) {
        const p = gameState.settings.priorityCrop;
        if (gameState.inventory[`seeds_${p}`] > 0 && gameState.level >= CONFIG.crops[p].unlockLevel) {
          setTimeout(() => plantCrop(plotId, p), 300);
        }
      }

      saveGame();
      renderCrops();
      renderInventory();
      renderDashboard();
      return true;
    }

    function saveGame() { localStorage.setItem('farmville_state', JSON.stringify(gameState)); setVariable('Player_Gold', gameState.gold); setVariable('Player_Level', gameState.level); setVariable('Player_XP', gameState.xp); notify('Game saved!', 'success'); }
    function loadFromStorage() { const saved = localStorage.getItem('farmville_state'); if (saved) { try { const p = JSON.parse(saved); gameState = { ...gameState, ...p }; gameState.plots.forEach(plot => { if (plot.state === 'growing' && plot.readyAt && Date.now() >= plot.readyAt) plot.state = 'ready'; }); } catch(e) {} } }

    function plantCrop(plotId, cropType) {
      const plot = gameState.plots[plotId - 1], crop = CONFIG.crops[cropType], seedKey = `seeds_${cropType}`;
      if (plot.state !== 'empty') { notify('Plot not empty!', 'error'); return false; }
      if (gameState.inventory[seedKey] < 1) { notify(`No ${crop.name} seeds!`, 'error'); return false; }
      if (gameState.level < crop.unlockLevel) { notify(`Unlock at Lv.${crop.unlockLevel}`, 'error'); return false; }

      // Trigger Portals task
      triggerTask(`Plant_Plot_${plotId}`);

      // Update local state
      gameState.inventory[seedKey]--;
      plot.state = 'growing';
      plot.cropType = cropType;
      plot.plantedAt = Date.now();
      plot.readyAt = Date.now() + (crop.growTime * 1000);

      notify(`Planted ${crop.name}!`, 'success');
      saveGame();
      renderCrops();
      renderInventory();
      return true;
    }

    function harvestPlot(plotId) {
      const plot = gameState.plots[plotId - 1]; if (plot.state !== 'ready') { notify('Not ready!', 'error'); return false; }
      const crop = CONFIG.crops[plot.cropType]; let amount = crop.yield; if (gameState.equipment.basket) amount = Math.floor(amount * 1.5);
      gameState.inventory[plot.cropType] += amount; addXP(5);
      const oldType = plot.cropType; plot.state = 'empty'; plot.cropType = null; plot.plantedAt = null; plot.readyAt = null;
      hideObject(`Plot_${plotId}_${crop.name}`); hideObject(`Plot_${plotId}_Ready`); showObject(`Plot_${plotId}_Empty`); playSound('harvest.mp3'); notify(`+${amount} ${crop.name}!`, 'success');
      if (gameState.settings.autoReplant) { const p = gameState.settings.priorityCrop; if (gameState.inventory[`seeds_${p}`] > 0 && gameState.level >= CONFIG.crops[p].unlockLevel) setTimeout(() => plantCrop(plotId, p), 300); }
      saveGame(); renderCrops(); renderInventory(); renderDashboard(); return true;
    }

    function plantAllEmpty() { const c = gameState.settings.priorityCrop; let n = 0; gameState.plots.forEach((p, i) => { if (p.state === 'empty' && gameState.inventory[`seeds_${c}`] > 0) if (plantCrop(i + 1, c)) n++; }); if (n > 0) notify(`Planted ${n} crops!`, 'success'); else notify('No seeds or plots!', 'error'); }

    function collectFromCow(id) {
      const c = gameState.animals.cows[id - 1];
      if (Date.now() < c.readyAt) { notify('Not ready!', 'error'); return; }
      triggerTask(`Collect_Cow_${id}`);
      gameState.inventory.milk++;
      c.readyAt = Date.now() + 90000;
      c.notified = false;
      addXP(3);
      notify('+1 Milk!', 'success');
      saveGame();
      renderAnimals();
      renderInventory();
    }

    function collectFromSheep(id) {
      const s = gameState.animals.sheep[id - 1];
      if (Date.now() < s.readyAt) { notify('Not ready!', 'error'); return; }
      triggerTask(`Collect_Sheep_${id}`);
      gameState.inventory.wool++;
      s.readyAt = Date.now() + 120000;
      s.notified = false;
      addXP(3);
      notify('+1 Wool!', 'success');
      saveGame();
      renderAnimals();
      renderInventory();
    }

    function collectFromPig(id) {
      if (gameState.inventory.corn < 1) { notify('Need corn!', 'error'); return; }
      triggerTask(`Collect_Pig_${id}`);
      gameState.inventory.corn--;
      gameState.inventory.fertilizer++;
      addXP(2);
      notify('+1 Fertilizer!', 'success');
      saveGame();
      renderAnimals();
      renderInventory();
    }

    function collectFromChicken(id) {
      const c = gameState.animals.chickens ? gameState.animals.chickens[id - 1] : null;
      if (c && Date.now() < c.readyAt) { notify('Not ready!', 'error'); return; }
      triggerTask(`Collect_Chicken_${id}`);
      gameState.inventory.egg = (gameState.inventory.egg || 0) + 1;
      if (c) { c.readyAt = Date.now() + 120000; c.notified = false; }
      addXP(2);
      notify('+1 Egg!', 'success');
      saveGame();
      renderAnimals();
      renderInventory();
    }

    function collectFromHive(id) {
      const h = gameState.hives[id - 1];
      if (Date.now() < h.readyAt) { notify('Not ready!', 'error'); return; }
      triggerTask(`Collect_Beehive_${id}`);
      gameState.inventory.honey++;
      h.readyAt = Date.now() + 180000;
      h.notified = false;
      addXP(5);
      notify('+1 Honey!', 'success');
      saveGame();
      renderAnimals();
      renderInventory();
    }

    function buySeeds(cropType, qty) { const c = CONFIG.crops[cropType], cost = c.seedCost * qty; if (gameState.gold < cost) { notify('Not enough gold!', 'error'); return; } if (gameState.level < c.unlockLevel) { notify(`Unlock at Lv.${c.unlockLevel}`, 'error'); return; } gameState.gold -= cost; gameState.inventory[`seeds_${cropType}`] += qty; playSound('purchase.mp3'); notify(`Bought ${qty} ${c.name} seeds!`, 'success'); saveGame(); updateHeader(); renderMarket(); renderInventory(); }
    function sellItem(item, qty) { if (gameState.inventory[item] < qty) { notify('Not enough!', 'error'); return; } const prices = { wheat: 5, corn: 8, carrots: 10, tomatoes: 15, potatoes: 12, pumpkins: 30, milk: 12, wool: 15, honey: 25, fertilizer: 5, bread: 35, cheese: 45, stew: 50, pie: 100, mead: 100, blanket: 60 }; const p = prices[item] || 5; gameState.inventory[item] -= qty; gameState.gold += p * qty; playSound('coins.mp3'); notify(`Sold for ${p * qty}g!`, 'success'); saveGame(); updateHeader(); renderMarket(); renderInventory(); }
    function buyEquipment(id) { const eq = CONFIG.equipment.find(e => e.id === id); if (gameState.equipment[id]) { notify('Already owned!', 'error'); return; } if (gameState.gold < eq.price) { notify('Not enough gold!', 'error'); return; } gameState.gold -= eq.price; gameState.equipment[id] = true; setVariable(`Player_Has_${id}`, 1); playSound('purchase.mp3'); notify(`Bought ${eq.name}!`, 'success'); saveGame(); updateHeader(); renderMarket(); }
    function craftItem(recipeId) { const r = CONFIG.recipes.find(x => x.id === recipeId); for (const [i, q] of Object.entries(r.ingredients)) if ((gameState.inventory[i] || 0) < q) { notify(`Need more ${i}!`, 'error'); return; } for (const [i, q] of Object.entries(r.ingredients)) gameState.inventory[i] -= q; gameState.inventory[recipeId] = (gameState.inventory[recipeId] || 0) + 1; addXP(r.xp); playSound('craft.mp3'); notify(`Crafted ${r.name}! +${r.xp} XP`, 'success'); saveGame(); renderCrafting(); renderInventory(); }

    function addXP(a) { gameState.xp += a; const t = CONFIG.levelThresholds; for (let i = t.length - 1; i >= 0; i--) if (gameState.xp >= t[i] && gameState.level < i + 1) { gameState.level = i + 1; playSound('levelup.mp3'); notify(`LEVEL UP! Now Lv.${gameState.level}!`, 'success'); setVariable('Player_Level', gameState.level); break; } updateHeader(); }
    function getXPProgress() { const t = CONFIG.levelThresholds; if (gameState.level >= t.length) return 100; const c = t[gameState.level - 1], n = t[gameState.level] || c + 1000; return Math.min(100, Math.max(0, ((gameState.xp - c) / (n - c)) * 100)); }
    function formatTime(s) { if (s <= 0) return 'Ready!'; const m = Math.floor(s / 60), sec = Math.floor(s % 60); return m > 0 ? `${m}m ${sec}s` : `${sec}s`; }

    function updateHeader() { document.getElementById('header-gold').textContent = gameState.gold.toLocaleString(); document.getElementById('header-level').textContent = gameState.level; document.getElementById('header-xp-bar').style.width = getXPProgress() + '%'; }

    function renderDashboard() {
      const readyCrops = gameState.plots.filter(p => p.state === 'ready').length, growingCrops = gameState.plots.filter(p => p.state === 'growing').length;
      const readyAnimals = [...gameState.animals.cows, ...gameState.animals.sheep].filter(a => Date.now() >= a.readyAt).length;
      const readyHives = gameState.hives.filter(h => Date.now() >= h.readyAt).length;
      const totalCrops = gameState.inventory.wheat + gameState.inventory.corn + gameState.inventory.carrots + gameState.inventory.tomatoes + gameState.inventory.potatoes + gameState.inventory.pumpkins;
      const totalSeeds = Object.keys(gameState.inventory).filter(k => k.startsWith('seeds_')).reduce((a, k) => a + gameState.inventory[k], 0);
      document.getElementById('tab-dashboard').innerHTML = `
        <div class="dashboard-grid">
          <div class="dashboard-card"><div class="card-header"><span class="card-icon">&#x1F33E;</span><div class="card-title">Crops</div></div><div class="quick-stats"><div class="quick-stat"><span class="quick-stat-icon">&#x2705;</span><div><div class="quick-stat-value">${readyCrops}</div><div class="quick-stat-label">Ready</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F331;</span><div><div class="quick-stat-value">${growingCrops}</div><div class="quick-stat-label">Growing</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F532;</span><div><div class="quick-stat-value">${24 - readyCrops - growingCrops}</div><div class="quick-stat-label">Empty</div></div></div></div></div>
          <div class="dashboard-card"><div class="card-header"><span class="card-icon">&#x1F404;</span><div class="card-title">Animals</div></div><div class="quick-stats"><div class="quick-stat"><span class="quick-stat-icon">&#x1F404;</span><div><div class="quick-stat-value">${gameState.animals.cows.filter(c => Date.now() >= c.readyAt).length}/3</div><div class="quick-stat-label">Cows</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F411;</span><div><div class="quick-stat-value">${gameState.animals.sheep.filter(s => Date.now() >= s.readyAt).length}/3</div><div class="quick-stat-label">Sheep</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F41D;</span><div><div class="quick-stat-value">${readyHives}/9</div><div class="quick-stat-label">Hives</div></div></div></div></div>
          <div class="dashboard-card"><div class="card-header"><span class="card-icon">&#x1F4E6;</span><div class="card-title">Resources</div></div><div class="quick-stats"><div class="quick-stat"><span class="quick-stat-icon">&#x1F33E;</span><div><div class="quick-stat-value">${totalCrops}</div><div class="quick-stat-label">Crops</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F331;</span><div><div class="quick-stat-value">${totalSeeds}</div><div class="quick-stat-label">Seeds</div></div></div><div class="quick-stat"><span class="quick-stat-icon">&#x1F95B;</span><div><div class="quick-stat-value">${gameState.inventory.milk + gameState.inventory.wool + gameState.inventory.honey}</div><div class="quick-stat-label">Products</div></div></div></div></div>
        </div>`;
    }

    function renderCrops() {
      let html = `<div class="crops-header"><div class="section-title">&#x1F33E; Crop Management</div><div class="crops-controls"><div class="control-group"><span class="control-label">Auto-Replant</span><div class="toggle-switch ${gameState.settings.autoReplant ? 'on' : ''}" onclick="toggleAutoReplant()"></div></div><div class="control-group"><span class="control-label">Priority</span><select id="priority-select" onchange="setPriority(this.value)">${Object.entries(CONFIG.crops).map(([k, v]) => gameState.level >= v.unlockLevel ? `<option value="${k}" ${gameState.settings.priorityCrop === k ? 'selected' : ''}>${v.name}</option>` : '').join('')}</select></div><button class="action-btn" onclick="plantAllEmpty()">&#x1F331; Plant All</button></div></div><div class="crops-grid">`;
      gameState.plots.forEach((plot, i) => {
        const num = i + 1;
        if (plot.state === 'empty') html += `<div class="plot-card empty"><span class="plot-number">#${num}</span><div class="plot-icon">&#x1F532;</div><div class="plot-name">Empty</div><select class="plot-select" id="sel-${num}">${Object.entries(CONFIG.crops).map(([k, v]) => gameState.level >= v.unlockLevel ? `<option value="${k}">${v.icon} ${v.name}</option>` : '').join('')}</select><button class="plot-btn" onclick="plantFromSelect(${num})">Plant</button></div>`;
        else if (plot.state === 'growing') { const c = CONFIG.crops[plot.cropType], r = Math.max(0, (plot.readyAt - Date.now()) / 1000), p = ((c.growTime - r) / c.growTime) * 100; html += `<div class="plot-card growing"><span class="plot-number">#${num}</span><div class="plot-icon">${c.icon}</div><div class="plot-name">${c.name}</div><div class="plot-status">${formatTime(r)}</div><div class="plot-progress"><div class="plot-progress-fill" style="width:${p}%"></div></div></div>`; }
        else { const c = CONFIG.crops[plot.cropType]; html += `<div class="plot-card ready"><span class="plot-number">#${num}</span><div class="plot-icon">${c.icon}</div><div class="plot-name">${c.name}</div><div class="plot-status ready">READY!</div><button class="plot-btn harvest" onclick="harvestPlot(${num})">Harvest</button></div>`; }
      });
      html += '</div>'; document.getElementById('tab-crops').innerHTML = html;
    }
    function plantFromSelect(id) { const s = document.getElementById(`sel-${id}`); if (s && s.value) plantCrop(id, s.value); }
    function toggleAutoReplant() { gameState.settings.autoReplant = !gameState.settings.autoReplant; saveGame(); renderCrops(); notify(`Auto-replant ${gameState.settings.autoReplant ? 'ON' : 'OFF'}`, 'success'); }
    function setPriority(c) { gameState.settings.priorityCrop = c; saveGame(); }

    function renderInventory() {
      const sections = [
        { title: 'Crops', items: [{ key: 'wheat', name: 'Wheat', icon: '&#x1F33E;' }, { key: 'corn', name: 'Corn', icon: '&#x1F33D;' }, { key: 'carrots', name: 'Carrots', icon: '&#x1F955;' }, { key: 'tomatoes', name: 'Tomatoes', icon: '&#x1F345;' }, { key: 'potatoes', name: 'Potatoes', icon: '&#x1F954;' }, { key: 'pumpkins', name: 'Pumpkins', icon: '&#x1F383;' }] },
        { title: 'Seeds', items: [{ key: 'seeds_wheat', name: 'Wheat Seeds', icon: '&#x1F331;' }, { key: 'seeds_corn', name: 'Corn Seeds', icon: '&#x1F331;' }, { key: 'seeds_carrots', name: 'Carrot Seeds', icon: '&#x1F331;' }, { key: 'seeds_tomatoes', name: 'Tomato Seeds', icon: '&#x1F331;' }, { key: 'seeds_potatoes', name: 'Potato Seeds', icon: '&#x1F331;' }, { key: 'seeds_pumpkins', name: 'Pumpkin Seeds', icon: '&#x1F331;' }] },
        { title: 'Products', items: [{ key: 'milk', name: 'Milk', icon: '&#x1F95B;' }, { key: 'wool', name: 'Wool', icon: '&#x1F9F6;' }, { key: 'honey', name: 'Honey', icon: '&#x1F36F;' }, { key: 'fertilizer', name: 'Fertilizer', icon: '&#x1F4A9;' }] },
        { title: 'Crafted', items: [{ key: 'bread', name: 'Bread', icon: '&#x1F35E;' }, { key: 'cheese', name: 'Cheese', icon: '&#x1F9C0;' }, { key: 'stew', name: 'Stew', icon: '&#x1F372;' }, { key: 'pie', name: 'Pie', icon: '&#x1F967;' }, { key: 'mead', name: 'Mead', icon: '&#x1F37A;' }, { key: 'blanket', name: 'Blanket', icon: '&#x1F9E3;' }] }
      ];
      let html = ''; sections.forEach(s => { html += `<div class="inventory-section"><div class="section-title">${s.title}</div><div class="inventory-grid">${s.items.map(i => `<div class="inv-item ${gameState.inventory[i.key] === 0 ? 'zero' : ''}"><div class="inv-icon">${i.icon}</div><div class="inv-name">${i.name}</div><div class="inv-qty">${gameState.inventory[i.key] || 0}</div></div>`).join('')}</div></div>`; });
      document.getElementById('tab-inventory').innerHTML = html;
    }

    function renderMarket() {
      let html = `<div class="market-tabs"><div class="market-tab active" onclick="switchMarketTab('seeds',this)">&#x1F331; Seeds</div><div class="market-tab" onclick="switchMarketTab('sell-crops',this)">&#x1F33E; Sell Crops</div><div class="market-tab" onclick="switchMarketTab('sell-products',this)">&#x1F36F; Sell Products</div><div class="market-tab" onclick="switchMarketTab('equipment',this)">&#x1F6E0;&#xFE0F; Equipment</div></div>`;
      html += `<div id="market-seeds" class="market-section active"><div class="market-grid">${Object.entries(CONFIG.crops).map(([k, v]) => `<div class="market-item"><span class="market-item-icon">${v.icon}</span><div class="market-item-info"><div class="market-item-name">${v.name} Seeds</div><div class="market-item-stock">Owned: ${gameState.inventory['seeds_' + k]} ${gameState.level < v.unlockLevel ? `(Lv.${v.unlockLevel})` : ''}</div></div><div class="market-item-actions"><div class="market-price">${v.seedCost}g ea</div><button class="market-btn" onclick="buySeeds('${k}',5)" ${gameState.level < v.unlockLevel || gameState.gold < v.seedCost * 5 ? 'disabled' : ''}>Buy 5</button></div></div>`).join('')}</div></div>`;
      html += `<div id="market-sell-crops" class="market-section"><div class="market-grid">${Object.entries(CONFIG.crops).map(([k, v]) => `<div class="market-item"><span class="market-item-icon">${v.icon}</span><div class="market-item-info"><div class="market-item-name">${v.name}</div><div class="market-item-stock">Owned: ${gameState.inventory[k]}</div></div><div class="market-item-actions"><div class="market-price">${v.sellPrice}g ea</div><button class="market-btn sell" onclick="sellItem('${k}',10)" ${gameState.inventory[k] < 10 ? 'disabled' : ''}>Sell 10</button></div></div>`).join('')}</div></div>`;
      html += `<div id="market-sell-products" class="market-section"><div class="market-grid">${[{ key: 'milk', name: 'Milk', icon: '&#x1F95B;', price: 12 }, { key: 'wool', name: 'Wool', icon: '&#x1F9F6;', price: 15 }, { key: 'honey', name: 'Honey', icon: '&#x1F36F;', price: 25 }, { key: 'bread', name: 'Bread', icon: '&#x1F35E;', price: 35 }, { key: 'cheese', name: 'Cheese', icon: '&#x1F9C0;', price: 45 }, { key: 'pie', name: 'Pie', icon: '&#x1F967;', price: 100 }, { key: 'mead', name: 'Mead', icon: '&#x1F37A;', price: 100 }].map(p => `<div class="market-item"><span class="market-item-icon">${p.icon}</span><div class="market-item-info"><div class="market-item-name">${p.name}</div><div class="market-item-stock">Owned: ${gameState.inventory[p.key] || 0}</div></div><div class="market-item-actions"><div class="market-price">${p.price}g ea</div><button class="market-btn sell" onclick="sellItem('${p.key}',1)" ${!gameState.inventory[p.key] ? 'disabled' : ''}>Sell</button></div></div>`).join('')}</div></div>`;
      html += `<div id="market-equipment" class="market-section"><div class="market-grid">${CONFIG.equipment.map(eq => `<div class="market-item"><span class="market-item-icon">${eq.icon}</span><div class="market-item-info"><div class="market-item-name">${eq.name}</div><div class="market-item-stock">${eq.desc}</div></div><div class="market-item-actions"><div class="market-price">${gameState.equipment[eq.id] ? 'OWNED' : eq.price + 'g'}</div><button class="market-btn" onclick="buyEquipment('${eq.id}')" ${gameState.equipment[eq.id] || gameState.gold < eq.price ? 'disabled' : ''}>${gameState.equipment[eq.id] ? '&#x2713;' : 'Buy'}</button></div></div>`).join('')}</div></div>`;
      document.getElementById('tab-market').innerHTML = html;
    }
    function switchMarketTab(id, el) { document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.market-section').forEach(s => s.classList.remove('active')); el.classList.add('active'); document.getElementById('market-' + id).classList.add('active'); }

    function renderCrafting() {
      let html = '<div class="crafting-grid">';
      CONFIG.recipes.forEach(r => {
        let canCraft = true, ingredientsHtml = '';
        for (const [i, q] of Object.entries(r.ingredients)) { const has = gameState.inventory[i] || 0, enough = has >= q; if (!enough) canCraft = false; const cfg = CONFIG.crops[i], icon = cfg ? cfg.icon : (i === 'milk' ? '&#x1F95B;' : i === 'honey' ? '&#x1F36F;' : i === 'wool' ? '&#x1F9F6;' : '&#x1F4E6;'); ingredientsHtml += `<span class="ingredient ${enough ? 'has' : 'missing'}">${icon} ${has}/${q}</span>`; }
        html += `<div class="recipe-card ${canCraft ? 'craftable' : ''}"><div class="recipe-header"><span class="recipe-name"><span class="recipe-icon">${r.icon}</span>${r.name}</span><div class="recipe-value"><div class="recipe-price">${r.sellPrice}g</div><div class="recipe-xp">+${r.xp} XP</div></div></div><div class="recipe-ingredients">${ingredientsHtml}</div><button class="craft-btn ${canCraft ? 'ready' : ''}" onclick="craftItem('${r.id}')" ${canCraft ? '' : 'disabled'}>${canCraft ? '&#x2692;&#xFE0F; Craft' : 'Missing Ingredients'}</button></div>`;
      });
      html += '</div>'; document.getElementById('tab-crafting').innerHTML = html;
    }

    function renderAnimals() {
      let html = `<div class="animals-section"><div class="section-title">&#x1F404; Cows (Milk)</div><div class="animals-grid">${gameState.animals.cows.map((c, i) => { const ready = Date.now() >= c.readyAt, rem = ready ? 0 : Math.ceil((c.readyAt - Date.now()) / 1000); return `<div class="animal-card ${ready ? 'ready' : ''}"><div class="animal-icon">&#x1F404;</div><div class="animal-name">Cow ${i + 1}</div><div class="animal-status ${ready ? 'ready' : 'cooldown'}">${ready ? 'Ready!' : formatTime(rem)}</div><button class="animal-btn" onclick="collectFromCow(${i + 1})" ${ready ? '' : 'disabled'}>Collect</button></div>`; }).join('')}</div></div>`;
      html += `<div class="animals-section"><div class="section-title">&#x1F411; Sheep (Wool)</div><div class="animals-grid">${gameState.animals.sheep.map((s, i) => { const ready = Date.now() >= s.readyAt, rem = ready ? 0 : Math.ceil((s.readyAt - Date.now()) / 1000); return `<div class="animal-card ${ready ? 'ready' : ''}"><div class="animal-icon">&#x1F411;</div><div class="animal-name">Sheep ${i + 1}</div><div class="animal-status ${ready ? 'ready' : 'cooldown'}">${ready ? 'Ready!' : formatTime(rem)}</div><button class="animal-btn" onclick="collectFromSheep(${i + 1})" ${ready ? '' : 'disabled'}>Collect</button></div>`; }).join('')}</div></div>`;
      html += `<div class="animals-section"><div class="section-title">&#x1F437; Pigs (Feed Corn)</div><div class="animals-grid">${gameState.animals.pigs.map((p, i) => { const hasCorn = gameState.inventory.corn > 0; return `<div class="animal-card ${hasCorn ? 'ready' : ''}"><div class="animal-icon">&#x1F437;</div><div class="animal-name">Pig ${i + 1}</div><div class="animal-status ${hasCorn ? 'ready' : 'cooldown'}">${hasCorn ? 'Feed me!' : 'Need corn'}</div><button class="animal-btn" onclick="collectFromPig(${i + 1})" ${hasCorn ? '' : 'disabled'}>Feed</button></div>`; }).join('')}</div></div>`;
      html += `<div class="animals-section"><div class="section-title">&#x1F41D; Beehives (Honey)</div><div class="animals-grid">${gameState.hives.map((h, i) => { const ready = Date.now() >= h.readyAt, rem = ready ? 0 : Math.ceil((h.readyAt - Date.now()) / 1000); return `<div class="animal-card ${ready ? 'ready' : ''}"><div class="animal-icon">&#x1F41D;</div><div class="animal-name">Hive ${i + 1}</div><div class="animal-status ${ready ? 'ready' : 'cooldown'}">${ready ? 'Ready!' : formatTime(rem)}</div><button class="animal-btn" onclick="collectFromHive(${i + 1})" ${ready ? '' : 'disabled'}>Collect</button></div>`; }).join('')}</div></div>`;
      document.getElementById('tab-animals').innerHTML = html;
    }

    function updateAllUI() { updateHeader(); renderDashboard(); renderCrops(); renderInventory(); renderMarket(); renderCrafting(); renderAnimals(); }

    document.querySelectorAll('.nav-tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById('tab-' + tab.dataset.tab).classList.add('active'); const n = tab.dataset.tab; if (n === 'dashboard') renderDashboard(); else if (n === 'crops') renderCrops(); else if (n === 'inventory') renderInventory(); else if (n === 'market') renderMarket(); else if (n === 'crafting') renderCrafting(); else if (n === 'animals') renderAnimals(); }); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Tab') { e.preventDefault(); closeMenu(); } if (e.key >= '1' && e.key <= '6') { const tabs = ['dashboard', 'crops', 'inventory', 'market', 'crafting', 'animals']; document.querySelector(`[data-tab="${tabs[parseInt(e.key) - 1]}"]`).click(); } });

    function notify(msg, type = 'success') { const c = document.getElementById('notifications'), n = document.createElement('div'); n.className = `notification ${type}`; n.innerHTML = `<span class="notification-icon">${type === 'success' ? '&#x2705;' : '&#x274C;'}</span><span class="notification-text">${msg}</span>`; c.appendChild(n); setTimeout(() => n.remove(), 3000); }

    function gameLoop() {
      // Check crops - trigger Ready task when timer completes
      gameState.plots.forEach((p, i) => {
        if (p.state === 'growing' && Date.now() >= p.readyAt) {
          p.state = 'ready';
          triggerTask(`Ready_Plot_${i + 1}`);
          notify(`Plot ${i + 1} is ready!`, 'success');
        }
      });

      // Check animals - trigger Ready tasks when cooldowns complete
      gameState.animals.cows.forEach((c, i) => {
        if (Date.now() >= c.readyAt && !c.notified) {
          triggerTask(`Ready_Cow_${i + 1}`);
          c.notified = true;
        }
      });
      gameState.animals.sheep.forEach((s, i) => {
        if (Date.now() >= s.readyAt && !s.notified) {
          triggerTask(`Ready_Sheep_${i + 1}`);
          s.notified = true;
        }
      });
      gameState.hives.forEach((h, i) => {
        if (Date.now() >= h.readyAt && !h.notified) {
          triggerTask(`Ready_Beehive_${i + 1}`);
          h.notified = true;
        }
      });

      // Update UI
      const activeTab = document.querySelector('.nav-tab.active')?.dataset.tab;
      if (activeTab === 'dashboard') renderDashboard();
      else if (activeTab === 'crops') renderCrops();
      else if (activeTab === 'animals') renderAnimals();
    }

    function init() {
      loadFromStorage();
      updateAllUI();
      setInterval(gameLoop, 1000);
      setInterval(() => { localStorage.setItem('farmville_state', JSON.stringify(gameState)); }, 30000);
      console.log('[Farmville] Initialized');
    }
    window.onload = init;
  </script>
</body>
</html>
